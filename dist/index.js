var e=require("@sassoftware/restaflib"),t=require("@sassoftware/restaf");function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},n.apply(this,arguments)}var r=function(e,t,n,r){try{var o=r.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,n,r,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}},o=function(t,n){try{var r,o="cas"===n.source?Promise.resolve(function(t,n){try{var r=n.store,o=n.session,a=n.appControl.dataControl,s=a.table,i=a.byvars,u=n.state.columns,l={};if(null===i||0===i.length)return Promise.resolve(null);for(var c in t)"_index_"!==c&&!1===u[c].custom&&(l[c]=t[c]);var f={};return i.forEach(function(e){f[e]=l[e]}),Promise.resolve(e.casUpdateData(r,o,{table:s,data:l,where:f}))}catch(e){return Promise.reject(e)}}(t,n)).then(function(e){r=e}):Promise.resolve(function(e,t){try{var n=t.store,r=t.session,o=t.appControl.dataControl,s=o.table,i=o.byvars;if(null===i||0===i.length)return Promise.resolve(null);var u="proc sql; update "+s.libref+"."+s.name+";",l="set ",c=" ";for(var f in e)l=l+c+f+"="+a(e[f]),c=", ";var m="where  ",v=" ";i.forEach(function(t){m=m+v+t+"="+a(e[t]),v="AND "});var h=(u=u+" "+m+";run;").split(/\r?\n/);console.log(h);var p={data:{code:h}};return Promise.resolve(n.apiCall(r.links("execute"),p)).then(function(e){return Promise.resolve(n.jobState(e,{qs:{newState:"Completed",timeout:1}})).then(function(e){return console.log(e.data),!0})})}catch(e){return Promise.reject(e)}}(t,n)).then(function(e){r=e});return Promise.resolve(o&&o.then?o.then(function(){return r}):r)}catch(e){return Promise.reject(e)}};function a(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}function s(e,t,n){if(!e.s){if(n instanceof u){if(!n.s)return void(n.o=s.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(s.bind(null,e,t),s.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var i=function(e,t){try{var o=function(){var e={};if(a.forEach(function(t,n){var r=t.Column.toLowerCase();t.name=r,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,t.custom=!1,e[r]=t}),null!=l)for(var t in l){var r=n({},l[t]);r.name=t,r.custom=!0,e[t]=r}return{columns:e,data:c}},a=e.schema,i=e.rows,l=t.appControl.dataControl.customColumns,c=[],f=(m=i,v=function(e){var n=function(e,t){var n={};if(t.forEach(function(t,r){var o=e[r],a=o.Column.toLowerCase();null==o.Label&&(o.Label=o.Column),n[a]=t}),null!=l)for(var r in l){var o=l[r],a=o.Column.toLowerCase();n[a]=o.value}return n}(a,i[e]);return Promise.resolve(r("init",n,e,t)).then(function(e){var t=e[0],n=e[1];0!==n.code&&console.log(JSON.stringify(n,null,4)),c.push(t)})},d=-1,function e(t){try{for(;++d<m.length;)if((t=v(d))&&t.then){if(!((n=t)instanceof u&&1&n.s))return void t.then(e,p||(p=s.bind(null,h=new u,2)));t=t.v}h?s(h,1,t):h=t}catch(e){s(h||(h=new u),2,e)}var n}(),h);return Promise.resolve(f&&f.then?f.then(o):o())}catch(e){return Promise.reject(e)}var m,v,h,p,d};const u=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{s(r,1,e(this.v))}catch(e){s(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?s(r,1,t?t(o):o):n?s(r,1,n(o)):s(r,2,o)}catch(e){s(r,2,e)}},r},e}();var l=function(t,r){try{var o=null,a="cas"===r.source?Promise.resolve(function(t,r){try{var o=r.store,a=r.session,s=n({},t);return null==s.table&&(s.table=r.appControl.dataControl.table),null==s.where&&(s.where={}),s.from<=0||-1===s.next?Promise.resolve(null):Promise.resolve(e.casFetchRows(o,a,s)).then(function(e){var t=null,o=function(){if(null!==e)return Promise.resolve(i(e.data,r)).then(function(o){t=o,r.state={modified:[],pagination:n({},e.pagination),currentPage:s,data:[],columns:[]},!0===r.appControl.dataControl.cachePolicy&&(r.state.data=t.data,r.state.columns=t.columns),t.pagination=n({},e.pagination)})}();return o&&o.then?o.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){o=e}):Promise.resolve(function(t,n){try{var r=n.store,o=n.tableSummary,a=n.appControl.dataControl.table,s=(a.libref+"."+a.name).toLowerCase();return Promise.resolve(e.computeFetchData(r,o,s,null,{offset:t.from-1,limit:t.count})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(i(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){o=e});return Promise.resolve(a&&a.then?a.then(function(){return o}):o)}catch(e){return Promise.reject(e)}};exports.cellEdit=function(e,t,a,s,i){try{var u,l=function(e){return u?e:Promise.resolve(r("main",c,a,i)).then(function(e){var t;function n(n){return t?n:(c=e[0],h.msg=h.msg+" / "+e[1],!0===i.appControl.dataControl.cachePolicy&&(i.state.data[a]=c),{data:c,status:h})}var s=function(){if(!0===v)return Promise.resolve(r("term",e[0],a,i)).then(function(n){return 2===(h=(e=n)[1]).statusCode?(t=1,{data:e[0],status:h}):Promise.resolve(o(c,i)).then(function(){})})}();return s&&s.then?s.then(n):n(s)})},c=n({},null!==s?s:i.state.data[a]),f=i.appControl.editControl,m=f.handlers,v=f.autoSave;c[e]=function(e,t){var n=e;return"string"!=typeof n||"decimal"!==t.Type&&"number"!==t.Type&&"double"!==t.Type||(n=parseFloat(1*e),!0===isNaN(e)&&(e=0)),n}(t,i.state.columns[e]);var h={statusCode:0,msg:""},p=function(){if(null!=m[e])return Promise.resolve(m[e](c,e,a,i)).then(function(e){if(c=e[0],2===(h=e[1]).statusCode)return u=1,{data:e[0],status:h}})}();return Promise.resolve(p&&p.then?p.then(l):l(p))}catch(e){return Promise.reject(e)}},exports.commonHandler=r,exports.fetchTableRows=l,exports.scrollTable=function(t,r){try{var o,a="cas"===r.source?Promise.resolve(function(e,t){try{var r,o=t.appControl.dataControl,a=o.table;if("first"===e)(r=n({},o.initialFetch)).table=a;else if(-1===(r=t.state.pagination[e]).next)return Promise.resolve(null);return Promise.resolve(l(r,t))}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){o=e}):Promise.resolve(function(t,n){try{var r=n.store,o=n.tableSummary,a=n.appControl.dataControl.table,s=(a.libref+"."+a.name).toLowerCase();return Promise.resolve(e.computeFetchData(r,o,s,t,{limit:n.appControl.dataControl.initialFetch.count})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(i(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){o=e});return Promise.resolve(a&&a.then?a.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},exports.setup=function(n,r){try{var o,a=function(){return o.appControl=r,o.id=Date(),o},s=t.initStore();null==n.authType&&(n.authType="code");var i=r.dataControl,u="cas"===i.source?Promise.resolve(e.casSetup(s,n)).then(function(e){o={source:i.source,store:s,session:e.session,servers:e.servers,restaflib:null,logonPayload:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}}}}):Promise.resolve(e.computeSetup(s,null,n)).then(function(t){return Promise.resolve(e.computeSetupTables(s,t,i.table)).then(function(e){o={store:s,session:t,tableSummary:e,servers:null,restaflib:null,logonPayload:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}}}})});return Promise.resolve(u&&u.then?u.then(a):a())}catch(e){return Promise.reject(e)}},exports.updateTableRows=o;
//# sourceMappingURL=index.js.map
