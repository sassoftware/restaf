import{casUpdateData as n,computeFetchData as e,casFetchRows as t,computeSetup as r,computeSetupTables as o,casSetup as i,caslRun as s,computeRun as u,casUpload as a,casAppendTable as l,casSaveTable as c}from"@sassoftware/restaflib";import{initStore as f}from"@sassoftware/restaf";function h(){return h=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},h.apply(this,arguments)}var v=function(n,e,t,r){try{var o=r.appControl.editControl.handlers;return null==o[n]?Promise.resolve([e,{statusCode:0,msg:null}]):Promise.resolve(o[n](e,t,r,n)).then(function(n){return[n[0],n[1]]})}catch(n){return Promise.reject(n)}};function m(n,e,t){if(!n.s){if(t instanceof p){if(!t.s)return void(t.o=m.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(m.bind(null,n,e),m.bind(null,n,2));n.s=e,n.v=t;var r=n.o;r&&r(n)}}var d=function(n,e,t){try{var r=t.data,o=t.table,i=t.where,s="proc sql; update "+o.libref+"."+o.name,u="SET ",a=" ";for(var l in r)u=u+a+l+"="+C(r[l]),a=", ";s=s+" "+u;var c=" WHERE ",f=" ";for(var h in i)c=c+f+h+"= "+C(i[h])+" ",f=" AND ";var v={data:{code:(s=s+" "+c+";run;").split(/\r?\n/)}};return Promise.resolve(n.apiCall(e.links("execute"),v)).then(function(e){return Promise.resolve(n.jobState(e,{qs:{newState:"Completed",timeout:1}})).then(function(n){return{statusCode:"completed"===n.data?0:1,msg:n.data}})})}catch(n){return Promise.reject(n)}};const p=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){const r=new n,o=this.s;if(o){const n=1&o?e:t;if(n){try{m(r,1,n(this.v))}catch(n){m(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?m(r,1,e?e(o):o):t?m(r,1,t(o)):m(r,2,o)}catch(n){m(r,2,n)}},r},n}();var P=function(e,t){try{var r=t.store,o=t.session,i="cas"===t.source?n:d,s=function(n,e){var t=e.appControl,r=t.table,o=t.byvars,i=e.state.columns,s={};for(var u in n)"_index_"!==u&&"_rowIndex"!==u&&!1===i[u].custom&&(s[u]=n[u]);var a={};return o.forEach(function(n){a[n]=s[n]}),{table:r,data:s,where:a}}(e,t);return Promise.resolve(i(r,o,s))}catch(n){return Promise.reject(n)}},y=function(n,e){try{var t,r=e.appControl.byvars;if(null===r||0===r.length)return Promise.resolve([null,{msg:"Error: Please specify a by variable",statusCode:1}]);var o=function(){if(!0!==Array.isArray(n))return Promise.resolve(P(n,e)).then(function(n){t=n});var r,o,i,s,u,a=(r=n,o=function(r){return Promise.resolve(P(n[r],e)).then(function(n){t=n})},u=-1,function n(e){try{for(;++u<r.length;)if((e=o(u))&&e.then){if(!((t=e)instanceof p&&1&t.s))return void e.then(n,s||(s=m.bind(null,i=new p,2)));e=e.v}i?m(i,1,e):i=e}catch(n){m(i||(i=new p),2,n)}var t}(),i);return a&&a.then?a.then(function(){}):void 0}();return Promise.resolve(o&&o.then?o.then(function(){return t}):t)}catch(n){return Promise.reject(n)}};function C(n){return null==n?".":"string"==typeof n?JSON.stringify(n):n.toString()}var b=function(n,e,t,r,o){try{var i,s=function(n){return i?n:Promise.resolve(v("main",u,t,o)).then(function(n){var e;function i(t){return e?t:(u=n[0],!0===m&&(o.state.data[r._rowIndex]=u),{data:u,status:d})}var s=function(){if(!0===f)return Promise.resolve(v("term",n[0],t,o)).then(function(t){return 2===(d=(n=t)[1]).statusCode?(e=1,{data:n[0],status:d}):Promise.resolve(y(n[0],o)).then(function(n){d=n})})}();return s&&s.then?s.then(i):i(s)})},u=h({},r),a=o.appControl.editControl,l=a.handlers,c=a.autoSave,f=null==c||c,m=null==o.appControl.cachePolicy||o.appControl.cachePolicy;u[n]=function(n,e){var t=n,r=e.Type.toLowerCase();return"string"!=typeof t||"decimal"!==r&&"number"!==r&&"double"!==r&&"float"!==r||(t=parseFloat(1*n),!0===isNaN(n)&&(n=0)),t}(e,o.state.columns[n]);var d={statusCode:0,msg:""},p=function(){if(null!=l[n])return Promise.resolve(l[n](u,n,t,o)).then(function(n){if(u=n[0],2===(d=n[1]).statusCode)return i=1,{data:n[0],status:d}})}();return Promise.resolve(p&&p.then?p.then(s):s(p))}catch(n){return Promise.reject(n)}};function g(n,e,t){if(!n.s){if(t instanceof j){if(!t.s)return void(t.o=g.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(g.bind(null,n,e),g.bind(null,n,2));n.s=e,n.v=t;var r=n.o;r&&r(n)}}var w=function(n,e){try{var t=function(){var n={};if(r.forEach(function(e,t){var r=e.Column.toLowerCase();e.name=r,e.Label=null==e.Label||0===e.Label.length?e.Column:e.Label,null==e.Type&&(e.Type=null==e.type?"double":e.type),e.custom=!1,n[r]=e}),null!=i)for(var e in i){var t=h({},i[e]);t.name=e,t.custom=!0,n[e]=t}return{columns:n,data:u,status:s}},r=n.schema,o=n.rows,i=e.appControl.customColumns,s={statusCode:0,msg:"Initialization was successful"},u=[],a=(l=o,c=function(n){var t=function(n,e,t){var r={_rowIndex:t};if(e.forEach(function(e,t){var o=n[t].Column.toLowerCase();r[o]=e}),null!=i)for(var o in i){var s=i[o],u=s.Column.toLowerCase();r[u]=s.value}return r}(r,o[n],n);return Promise.resolve(v("init",t,n,e)).then(function(n){s=n[1],u.push(n[0])})},d=-1,function n(e){try{for(;++d<l.length;)if((e=c(d))&&e.then){if(!((t=e)instanceof j&&1&t.s))return void e.then(n,m||(m=g.bind(null,f=new j,2)));e=e.v}f?g(f,1,e):f=e}catch(n){g(f||(f=new j),2,n)}var t}(),f);return Promise.resolve(a&&a.then?a.then(t):t())}catch(n){return Promise.reject(n)}var l,c,f,m,d};const j=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){const r=new n,o=this.s;if(o){const n=1&o?e:t;if(n){try{g(r,1,n(this.v))}catch(n){g(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?g(r,1,e?e(o):o):t?g(r,1,t(o)):g(r,2,o)}catch(n){g(r,2,n)}},r},n}();var E=function(n,r,o){try{var i,s="cas"===r.source?Promise.resolve(function(n,e,r){try{var o,i=e.store,s=e.session,u=e.appControl,a=u.initialFetch,l=u.table,c=null==e.appControl.cachePolicy||e.appControl.cachePolicy;if(null!=r)o=h({},r);else if("first"===n)o=h({},a);else if(null!==n&&(-1===(o=h({},e.state.pagination[n])).next||o.from<=0))return Promise.resolve(null);var f={};return null!=o.qs?((f=h({},o.qs)).from=f.start+1,f.count=f.limit):f=h({},o),f.from<=0||-1===f.next?Promise.resolve(null):(null==f.where&&(f.where=" "),f.table=l,Promise.resolve(t(i,s,f)).then(function(n){var t=null;return function(){if(null!==n)return Promise.resolve(w(n.data,e)).then(function(r){return t=r,e.state={modified:[],pagination:h({},n.pagination),currentPage:o,data:[],columns:[]},!0===c&&(e.state.data=t.data,e.state.columns=t.columns),t.pagination=h({},n.pagination),t})}()}))}catch(n){return Promise.reject(n)}}(n,r,o)).then(function(n){i=n}):Promise.resolve(function(n,t,r){try{var o=t.store,i=t.tableSummary,s=t.appControl,u=s.table,a=s.initialFetch,l=null==t.appControl.cachePolicy||t.appControl.cachePolicy,c=null,f=(u.libref+"."+u.name).toLowerCase();return null==r?"first"===n&&(c=h({},a)):c=h({},r),Promise.resolve(e(o,i,f,n,c)).then(function(n){var e=null,r=function(){if(null!==n)return Promise.resolve(w(n,t)).then(function(n){e=n,t.state={modified:[],pagination:{},currentPage:{},data:[],columns:[]},!0===l&&(t.state.data=e.data,t.state.columns=e.columns)})}();return r&&r.then?r.then(function(){return e}):e})}catch(n){return Promise.reject(n)}}(n,r,o)).then(function(n){i=n});return Promise.resolve(s&&s.then?s.then(function(){return i}):i)}catch(n){return Promise.reject(n)}},S=function(n,e){try{var t,u=function(){console.log(e.editControl.handlers.fseinit);var n=function(){if(null!=e.editControl.handlers.fseinit)return Promise.resolve(e.editControl.handlers.fseinit(t,"fseinit")).then(function(n){if(2===n.statusCode)throw console.log(JSON.stringify(n,null,4)),"fseinit failed. Please see console"})}();return n&&n.then?n.then(function(n){return t}):t},a=f();null==n.authType&&(n.authType="code");var l="cas"===e.source?Promise.resolve(function(n,e,t){try{return Promise.resolve(i(n,e)).then(function(r){var o=null!=t.editControl.handlers.fseinit?null:t.preamble,i={source:t.source,store:n,session:r.session,servers:r.servers,restaflib:null,logonPayload:e,appControl:t,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},u=function(){if(null!==o)return Promise.resolve(s(n,r.session,o)).then(function(n){if(0!==n.disposition.statusCode)throw console.log(JSON.stringify(n,null,4)),"Preamble failed. Please see console"})}();return u&&u.then?u.then(function(n){return i}):i})}catch(n){return Promise.reject(n)}}(a,n,e)).then(function(n){t=n}):Promise.resolve(function(n,e,t){try{var i=null!=t.editControl.handlers.fseinit?null:t.preamble;return Promise.resolve(r(n,t.computeContext,e)).then(function(r){function s(e){return Promise.resolve(o(n,r,t.table,i)).then(function(n){return u.tableSummary=n,u})}var u={source:t.source,store:n,session:r,servers:null,restaflib:null,logonPayload:e,appControl:t,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},a=function(){if(null!=t.editControl.handlers.fseinit)return Promise.resolve(t.editControl.handlers.fseinit(u,"fseinit")).then(function(n){if(2===n.statusCode)throw console.log(JSON.stringify(n,null,4)),"fseinit failed. Please see console"})}();return a&&a.then?a.then(s):s()})}catch(n){return Promise.reject(n)}}(a,n,e)).then(function(n){t=n});return Promise.resolve(l&&l.then?l.then(u):u())}catch(n){return Promise.reject(n)}};function x(n,e,t){if(!n.s){if(t instanceof L){if(!t.s)return void(t.o=x.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(x.bind(null,n,e),x.bind(null,n,2));n.s=e,n.v=t;var r=n.o;r&&r(n)}}const L=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){const r=new n,o=this.s;if(o){const n=1&o?e:t;if(n){try{x(r,1,n(this.v))}catch(n){x(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?x(r,1,e?e(o):o):t?x(r,1,t(o)):x(r,2,o)}catch(n){x(r,2,n)}},r},n}();function O(n){return n instanceof L&&1&n.s}var _=function(n,t,r){try{var o,i=null!=r?r:t.appControl.table,a="cas"===t.source?Promise.resolve(function(n,e,t){try{return Promise.resolve(s(t.store,t.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:n,column:e},!0)).then(function(n){if(0!==n.results.casResults.data.statusCode)throw"Failed to create unique list";return n.results.casResults.data.data})}catch(n){return Promise.reject(n)}}(i,n,t)).then(function(n){o=n}):Promise.resolve(function(n,t,r){try{var o=r.store;return Promise.resolve(u(o,r.session,"\n    PROC SQL;\n    CREATE TABLE WORK.QUERY\n    AS\n    SELECT distinct("+t+") as utype FROM "+n.libref+"."+n.name+";\n   QUIT;")).then(function(n){function r(){return s[t]=a,s}var i,s={},u="first",a=[],l=function(n,e){var t;do{var r=n();if(r&&r.then){if(!O(r)){t=!0;break}r=r.v}var o=e();if(O(o)&&(o=o.v),!o)return r}while(!o.then);var i=new L,s=x.bind(null,i,2);return(t?r.then(u):o.then(a)).then(void 0,s),i;function u(t){for(r=t;O(o=e())&&(o=o.v),o;){if(o.then)return void o.then(a).then(void 0,s);if((r=n())&&r.then){if(!O(r))return void r.then(u).then(void 0,s);r=r.v}}x(i,1,r)}function a(t){if(t){do{if((r=n())&&r.then){if(!O(r))return void r.then(u).then(void 0,s);r=r.v}if(O(t=e())&&(t=t.v),!t)return void x(i,1,r)}while(!t.then);t.then(a).then(void 0,s)}else x(i,1,r)}}(function(){return Promise.resolve(e(o,n,"QUERY",u)).then(function(n){var e=(i=n).rows.map(function(n){return n[0]});a.push.apply(a,e),u="next"})},function(){return i.scrollOptions.indexOf("next")>=0});return l&&l.then?l.then(r):r()})}catch(n){return Promise.reject(n)}}(i,n,t)).then(function(n){o=n});return Promise.resolve(a&&a.then?a.then(function(){return o}):o)}catch(n){return Promise.reject(n)}},T=function(n,e,t,r,o,i,s){try{var c=o.store,f=o.session;null===e&&(e=o.state.data);var v=Object.keys(e[0]),m=["_index_","_rowIndex"];null!==t&&(m=m.concat(t));var d=v.filter(function(n){return!(m.indexOf(n)>=0)}),p={};d.forEach(function(n){p[n]=o.state.columns[n]});var P=null;"cas"===o.source&&(P=d.join(",")+"\n");for(var y,C=function(n){var t=e[n];t=h({},t,r);var o=[];d.forEach(function(n,e){var r=t[n];"string"==typeof r&&(r=r.trim()),o[e]=r}),P=null===P?o.join(",")+"\n":P+o.join(",")+"\n"},b=0;b<e.length;b++)C(b);var g="cas"===o.source?Promise.resolve(function(n,e,t,r,o,i){try{return Promise.resolve(a(n,e,null,t.caslib+"."+t.name,!0,r)).then(function(r){return null!=o?Promise.resolve(l(n,e,t,o,i)).then(function(n){return r=n}):r})}catch(n){return Promise.reject(n)}}(c,f,n,P,i,s)).then(function(n){y=n}):Promise.resolve(function(n,e,t,r,o){try{var i="data "+r.libref+"."+r.name+"; INFILE datalines delimiter=',' ;\n",s="",a="INPUT ";for(var l in t){var c=t[l];a=a+c.Column+" ","CHAR"===c.Type&&(s=s+"  "+c.Column+" $ "+c.length+" \n")}return s.length>0&&(s="LENGTH "+s+";\n"),i=i+";\n"+s+(a+=";\n")+"datalines;\n"+o+"\n; run; proc print;run;\n",Promise.resolve(u(n,e,i)).then(function(){return{msg:"done",statusCode:0}})}catch(n){return Promise.reject(n)}}(c,f,p,n,P)).then(function(n){y=n});return Promise.resolve(g&&g.then?g.then(function(){return y}):y)}catch(n){return Promise.reject(n)}},R=function(n,e){try{var t=n.store,r=n.session;return"compute"===n.source?Promise.resolve({msg:"Action does not apply to SAS 9 tables",statusCode:0}):Promise.resolve(c(t,r,null!=e?e:n.appControl.table)).then(function(){return{msg:"Table saved",statusCode:0}})}catch(n){return Promise.reject(n)}};async function N(n,e){const{store:t,session:r}=n,o=n.appControl.editControl.handlers;return null!=o.fseterm&&await o.fseterm(n),!1!==e&&await t.apiCall(r.links("delete")),{msg:"Session terminated",statusCode:0}}export{b as cellEdit,v as commonHandler,_ as distinctValues,R as saveTable,E as scrollTable,S as setup,N as termSession,y as updateTableRows,T as uploadData};
//# sourceMappingURL=index.module.js.map
