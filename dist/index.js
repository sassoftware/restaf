var e=require("@sassoftware/restaflib"),t=require("@sassoftware/restaf");function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},n.apply(this,arguments)}var r=function(e,t,n,r){try{var o=r.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,n,r,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}};function o(e,t,n){if(!e.s){if(n instanceof a){if(!n.s)return void(n.o=o.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(o.bind(null,e,t),o.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var s=function(e,t,n){try{var r=n.data,o=n.table,s=n.where,a="proc sql; update "+o.libref+"."+o.name,i="SET ",u=" ";for(var c in r)i=i+u+c+"="+l(r[c]),u=", ";a=a+" "+i;var f=" WHERE ",m=" ";for(var h in s)f=f+m+h+"= "+l(s[h])+" ",m=" AND ";var v={data:{code:(a=a+" "+f+";run;").split(/\r?\n/)}};return Promise.resolve(e.apiCall(t.links("execute"),v)).then(function(t){return Promise.resolve(e.jobState(t,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}};const a=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,s=this.s;if(s){const e=1&s?t:n;if(e){try{o(r,1,e(this.v))}catch(e){o(r,2,e)}return r}return this}return this.o=function(e){try{const s=e.v;1&e.s?o(r,1,t?t(s):s):n?o(r,1,n(s)):o(r,2,s)}catch(e){o(r,2,e)}},r},e}();var i=function(t,n){try{var r=n.store,o=n.session,a="cas"===n.source?e.casUpdateData:s,i=function(e,t){var n=t.appControl,r=n.table,o=n.byvars,s=t.state.columns,a={};for(var i in e)"_index_"!==i&&"_rowIndex"!==i&&!1===s[i].custom&&(a[i]=e[i]);var u={};return o.forEach(function(e){u[e]=a[e]}),{table:r,data:a,where:u}}(t,n);return Promise.resolve(a(r,o,i))}catch(e){return Promise.reject(e)}},u=function(e,t){try{var n,r=t.appControl.byvars;if(null===r||0===r.length)return Promise.resolve([null,{msg:"Error: Please specify a by variable",statusCode:1}]);var s=function(){if(!0!==Array.isArray(e))return Promise.resolve(i(e,t)).then(function(e){n=e});var r,s,u,l,c,f=(r=e,s=function(r){return Promise.resolve(i(e[r],t)).then(function(e){n=e})},c=-1,function e(t){try{for(;++c<r.length;)if((t=s(c))&&t.then){if(!((n=t)instanceof a&&1&n.s))return void t.then(e,l||(l=o.bind(null,u=new a,2)));t=t.v}u?o(u,1,t):u=t}catch(e){o(u||(u=new a),2,e)}var n}(),u);return f&&f.then?f.then(function(){}):void 0}();return Promise.resolve(s&&s.then?s.then(function(){return n}):n)}catch(e){return Promise.reject(e)}};function l(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}function c(e,t,n){if(!e.s){if(n instanceof m){if(!n.s)return void(n.o=c.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(c.bind(null,e,t),c.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var f=function(e,t){try{var o=function(){var e={};if(s.forEach(function(t,n){var r=t.Column.toLowerCase();t.name=r,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,e[r]=t}),null!=i)for(var t in i){var r=n({},i[t]);r.name=t,r.custom=!0,e[t]=r}return{columns:e,data:l,status:u}},s=e.schema,a=e.rows,i=t.appControl.customColumns,u={statusCode:0,msg:"Initialization was successful"},l=[],f=(h=a,v=function(e){var n=function(e,t,n){var r={_rowIndex:n};if(t.forEach(function(t,n){var o=e[n].Column.toLowerCase();r[o]=t}),null!=i)for(var o in i){var s=i[o],a=s.Column.toLowerCase();r[a]=s.value}return r}(s,a[e],e);return Promise.resolve(r("init",n,e,t)).then(function(e){u=e[1],l.push(e[0])})},P=-1,function e(t){try{for(;++P<h.length;)if((t=v(P))&&t.then){if(!((n=t)instanceof m&&1&n.s))return void t.then(e,d||(d=c.bind(null,p=new m,2)));t=t.v}p?c(p,1,t):p=t}catch(e){c(p||(p=new m),2,e)}var n}(),p);return Promise.resolve(f&&f.then?f.then(o):o())}catch(e){return Promise.reject(e)}var h,v,p,d,P};const m=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{c(r,1,e(this.v))}catch(e){c(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?c(r,1,t?t(o):o):n?c(r,1,n(o)):c(r,2,o)}catch(e){c(r,2,e)}},r},e}();exports.cellEdit=function(e,t,o,s,a){try{var i,l=function(e){return i?e:Promise.resolve(r("main",c,o,a)).then(function(e){var t;function n(n){return t?n:(c=e[0],!0===p&&(a.state.data[s._rowIndex]=c),{data:c,status:d})}var i=function(){if(!0===v)return Promise.resolve(r("term",e[0],o,a)).then(function(n){return 2===(d=(e=n)[1]).statusCode?(t=1,{data:e[0],status:d}):Promise.resolve(u(e[0],a)).then(function(e){d=e})})}();return i&&i.then?i.then(n):n(i)})},c=n({},s),f=a.appControl.editControl,m=f.handlers,h=f.autoSave,v=null==h||h,p=null==a.appControl.cachePolicy||a.appControl.cachePolicy;c[e]=function(e,t){var n=e,r=t.Type.toLowerCase();return"string"!=typeof n||"decimal"!==r&&"number"!==r&&"double"!==r&&"float"!==r||(n=parseFloat(1*e),!0===isNaN(e)&&(e=0)),n}(t,a.state.columns[e]);var d={statusCode:0,msg:""},P=function(){if(null!=m[e])return Promise.resolve(m[e](c,e,o,a)).then(function(e){if(c=e[0],2===(d=e[1]).statusCode)return i=1,{data:e[0],status:d}})}();return Promise.resolve(P&&P.then?P.then(l):l(P))}catch(e){return Promise.reject(e)}},exports.commonHandler=r,exports.distinctValues=function(t,n,r,o){try{var s,a="cas"===r.source?Promise.resolve(function(t,n,r,o){try{return Promise.resolve(e.caslRun(r.store,r.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:t,column:n},!0)).then(function(e){if(0!==e.results.casResults.data.statusCode)throw"Failed to create unique list";return e.results.casResults.data.data})}catch(e){return Promise.reject(e)}}(t,n,r)).then(function(e){s=e}):Promise.resolve(function(e,t,n){try{var r={};return r[e]=[],Promise.resolve(r)}catch(e){return Promise.reject(e)}}(t)).then(function(e){s=e});return Promise.resolve(a&&a.then?a.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},exports.fetchTableRows=function(t,r){try{return Promise.resolve("cas"===r.source?function(t,r){try{var o=r.store,s=r.session,a={};return null!=t.qs?((a=n({},t.qs)).from=a.start+1,a.count=a.limit):a=n({},t),a.from<=0||-1===a.next?Promise.resolve(null):(null==a.where&&(a.where=" "),Promise.resolve(e.casFetchRows(o,s,a)).then(function(e){var t=null,o=function(){if(null!==e)return Promise.resolve(f(e.data,r)).then(function(o){t=o,r.state={modified:[],pagination:n({},e.pagination),currentPage:a,data:[],columns:[]},!0===r.appControl.cachePolicy&&(r.state.data=t.data,r.state.columns=t.columns),t.pagination=n({},e.pagination)})}();return o&&o.then?o.then(function(){return t}):t}))}catch(e){return Promise.reject(e)}}(t,r):function(t,n){try{var r=n.store,o=n.tableSummary,s=n.appControl.table,a=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(e.computeFetchData(r,o,a,null,{qs:{start:t.from-1,limit:t.count,format:null==t.format&&t.format}})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(f(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r))}catch(e){return Promise.reject(e)}},exports.saveTable=function(t,n){try{var r=t.store,o=t.session;return"compute"===t.source?Promise.resolve({msg:"Action does not apply to SAS 9 tables",statusCode:0}):Promise.resolve(e.casSaveTable(r,o,null!=n?n:t.appControl.table)).then(function(){return{msg:"Table saved",statusCode:0}})}catch(e){return Promise.reject(e)}},exports.scrollTable=function(t,r,o){try{var s,a="cas"===r.source?Promise.resolve(function(t,r,o){try{var s,a=r.store,i=r.session,u=r.appControl,l=u.initialFetch,c=u.table,m=null==r.appControl.cachePolicy||r.appControl.cachePolicy;if(null!=o)s=n({},o);else if("first"===t)s=n({},l);else if(null!==t&&(-1===(s=n({},r.state.pagination[t])).next||s.from<=0))return Promise.resolve(null);var h={};return null!=s.qs?((h=n({},s.qs)).from=h.start+1,h.count=h.limit):h=n({},s),h.from<=0||-1===h.next?Promise.resolve(null):(null==h.where&&(h.where=" "),h.table=c,Promise.resolve(e.casFetchRows(a,i,h)).then(function(e){var t=null;return function(){if(null!==e)return Promise.resolve(f(e.data,r)).then(function(o){return t=o,r.state={modified:[],pagination:n({},e.pagination),currentPage:s,data:[],columns:[]},!0===m&&(r.state.data=t.data,r.state.columns=t.columns),t.pagination=n({},e.pagination),t})}()}))}catch(e){return Promise.reject(e)}}(t,r,o)).then(function(e){s=e}):Promise.resolve(function(t,r,o){try{var s=r.store,a=r.tableSummary,i=r.appControl,u=i.table,l=i.initialFetch,c=null==r.appControl.cachePolicy||r.appControl.cachePolicy,m=null,h=(u.libref+"."+u.name).toLowerCase();return null==o?"first"===t&&(m=n({},l)):m=n({},o),Promise.resolve(e.computeFetchData(s,a,h,t,m)).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(f(e,r)).then(function(e){t=e,r.state={modified:[],pagination:{},currentPage:{},data:[],columns:[]},!0===c&&(r.state.data=t.data,r.state.columns=t.columns)})}();return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r,o)).then(function(e){s=e});return Promise.resolve(a&&a.then?a.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},exports.setup=function(n,r){try{var o,s=t.initStore();null==n.authType&&(n.authType="code");var a="cas"===r.source?Promise.resolve(function(t,n,r){try{return console.log(t),console.log(n),Promise.resolve(e.casSetup(t,n)).then(function(o){var s={source:r.source,store:t,session:o.session,servers:o.servers,restaflib:null,logonPayload:n,appControl:r,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},a=function(){if(null!=r.preamble)return Promise.resolve(e.caslRun(t,o.session,r.preamble)).then(function(e){if(0!==e.disposition.statusCode)throw console.log(JSON.stringify(e,null,4)),"Preamble failed. Please see console"})}();return a&&a.then?a.then(function(e){return s}):s})}catch(e){return Promise.reject(e)}}(s,n,r)).then(function(e){o=e}):Promise.resolve(function(t,n,r){try{return Promise.resolve(e.computeSetup(t,r.computeContext,n)).then(function(o){return Promise.resolve(e.computeSetupTables(t,o,r.table,r.preamble)).then(function(e){return{source:r.source,store:t,session:o,tableSummary:e,servers:null,restaflib:null,logonPayload:n,appControl:r,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(e){return Promise.reject(e)}}(s,n,r)).then(function(e){o=e});return Promise.resolve(a&&a.then?a.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},exports.updateTableRows=u,exports.uploadData=function(t,r,o,s,a,i,u){try{var l=a.store,c=a.session,f=Object.keys(r[0]),m=["_index_","_rowIndex"];null!==o&&(m=m.concat(o));var h=f.filter(function(e){return!(m.indexOf(e)>=0)}),v={};h.forEach(function(e){v[e]=a.state.columns[e]});var p=null;"cas"===a.source&&(p=h.join(",")+"\n");for(var d,P=function(e){var t=r[e];t=n({},t,s);var o=[];h.forEach(function(e,n){var r=t[e];"string"==typeof r&&(r=r.trim()),o[n]=r}),p=null===p?o.join(",")+"\n":p+o.join(",")+"\n"},y=0;y<r.length;y++)P(y);var b="cas"===a.source?Promise.resolve(function(t,n,r,o,s,a){try{return Promise.resolve(e.casUpload(t,n,null,r.caslib+"."+r.name,!0,o)).then(function(o){return null!=s?Promise.resolve(e.casAppendTable(t,n,r,s,a)).then(function(e){return o=e}):o})}catch(e){return Promise.reject(e)}}(l,c,t,p,i,u)).then(function(e){d=e}):Promise.resolve(function(t,n,r,o,s){try{var a="data "+o.libref+"."+o.name+"; INFILE datalines delimiter=',' ;\n",i="",u="INPUT ";for(var l in r){var c=r[l];u=u+c.Column+" ","CHAR"===c.Type&&(i=i+"  "+c.Column+" $ "+c.length+" \n")}return i.length>0&&(i="LENGTH "+i+";\n"),a=a+";\n"+i+(u+=";\n")+"datalines;\n"+s+"\n; run; proc print;run;\n",Promise.resolve(e.computeRun(t,n,a)).then(function(){return{msg:"done",statusCode:0}})}catch(e){return Promise.reject(e)}}(l,c,v,t,p)).then(function(e){d=e});return Promise.resolve(b&&b.then?b.then(function(){return d}):d)}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=index.js.map
