import{casUpdateData as e,computeFetchData as t,casFetchRows as n,computeSetup as r,computeSetupTables as o,casSetup as s}from"@sassoftware/restaflib";import{initStore as a}from"@sassoftware/restaf";function u(){return u=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u.apply(this,arguments)}var i=function(e,t,n,r){try{var o=r.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,n,r,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}},l=function(t,n){try{var r,o="cas"===n.source?Promise.resolve(function(t,n){try{var r=n.store,o=n.session,s=n.appControl,a=s.table,u=s.byvars,i=n.state.columns;if(null===u||0===u.length)return Promise.resolve(null);var l={};for(var c in t)"_index_"!==c&&!1===i[c].custom&&(l[c]=t[c]);var f={};u.forEach(function(e){f[e]=l[e]});var m={table:a,data:l,where:f};return console.log("updating record"),Promise.resolve(e(r,o,m)).then(function(e){return console.log(e),console.log(e.items().toJS()),{statusCode:0,msg:"Save successful"}})}catch(e){return Promise.reject(e)}}(t,n)).then(function(e){r=e}):Promise.resolve(function(e,t){try{var n=t.store,r=t.session,o=t.appControl,s=o.table,a=o.byvars,u=t.state.columns;if(null===a||0===a.length)return Promise.resolve(null);var i="proc sql; update "+s.libref+"."+s.name,l="SET ",f=" ";for(var m in e)!1===u[m].custom&&(l=l+f+m+"="+c(e[m])),f=", ";i=i+" "+l;var v=" WHERE ",h=" ";a.forEach(function(t){v=v+h+t+"="+c(e[t]),h="AND "});var p={data:{code:(i=i+" "+v+";run;").split(/\r?\n/)}};return Promise.resolve(n.apiCall(r.links("execute"),p)).then(function(e){return Promise.resolve(n.jobState(e,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}}(t,n)).then(function(e){r=e});return Promise.resolve(o&&o.then?o.then(function(){return r}):r)}catch(e){return Promise.reject(e)}};function c(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}var f=function(e,t,n,r,o){try{var s,a=function(e){return s?e:Promise.resolve(i("main",c,n,o)).then(function(e){var t;function r(r){return t?r:(c=e[0],h.msg=h.msg+" / "+e[1],!0===o.appControl.cachePolicy&&(o.state.data[n]=c),{data:c,status:h})}var s=function(){if(!0===v)return Promise.resolve(i("term",e[0],n,o)).then(function(n){return 2===(h=(e=n)[1]).statusCode?(t=1,{data:e[0],status:h}):Promise.resolve(l(e[0],o)).then(function(){})})}();return s&&s.then?s.then(r):r(s)})},c=u({},null!==r?r:o.state.data[n]),f=o.appControl.editControl,m=f.handlers,v=f.autoSave;c[e]=function(e,t){var n=e;return"string"!=typeof n||"decimal"!==t.Type&&"number"!==t.Type&&"double"!==t.Type||(n=parseFloat(1*e),!0===isNaN(e)&&(e=0)),n}(t,o.state.columns[e]);var h={statusCode:0,msg:""},p=function(){if(null!=m[e])return Promise.resolve(m[e](c,e,n,o)).then(function(e){if(c=e[0],2===(h=e[1]).statusCode)return s=1,{data:e[0],status:h}})}();return Promise.resolve(p&&p.then?p.then(a):a(p))}catch(e){return Promise.reject(e)}};function m(e,t,n){if(!e.s){if(n instanceof h){if(!n.s)return void(n.o=m.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(m.bind(null,e,t),m.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var v=function(e,t){try{var n=function(){var e={};if(r.forEach(function(t,n){var r=t.Column.toLowerCase();t.name=r,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,t.custom=!1,e[r]=t}),null!=s)for(var t in s){var n=u({},s[t]);n.name=t,n.custom=!0,e[t]=n}return{columns:e,data:a}},r=e.schema,o=e.rows,s=t.appControl.customColumns,a=[],l=(c=o,f=function(e){var n=function(e,t){var n={};if(t.forEach(function(t,r){var o=e[r],s=o.Column.toLowerCase();null==o.Label&&(o.Label=o.Column),n[s]=t}),null!=s)for(var r in s){var o=s[r],a=o.Column.toLowerCase();n[a]=o.value}return n}(r,o[e]);return Promise.resolve(i("init",n,e,t)).then(function(e){var t=e[0],n=e[1];0!==n.code&&console.log(JSON.stringify(n,null,4)),a.push(t)})},d=-1,function e(t){try{for(;++d<c.length;)if((t=f(d))&&t.then){if(!((n=t)instanceof h&&1&n.s))return void t.then(e,p||(p=m.bind(null,v=new h,2)));t=t.v}v?m(v,1,t):v=t}catch(e){m(v||(v=new h),2,e)}var n}(),v);return Promise.resolve(l&&l.then?l.then(n):n())}catch(e){return Promise.reject(e)}var c,f,v,p,d};const h=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{m(r,1,e(this.v))}catch(e){m(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?m(r,1,t?t(o):o):n?m(r,1,n(o)):m(r,2,o)}catch(e){m(r,2,e)}},r},e}();var p=function(e,r){try{var o=null,s="cas"===r.source?Promise.resolve(function(e,t){try{var r=t.store,o=t.session,s=u({},e);return null==s.table&&(s.table=t.appControl.table),null==s.where&&(s.where={}),s.from<=0||-1===s.next?Promise.resolve(null):Promise.resolve(n(r,o,s)).then(function(e){var n=null,r=function(){if(null!==e)return Promise.resolve(v(e.data,t)).then(function(r){n=r,t.state={modified:[],pagination:u({},e.pagination),currentPage:s,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=n.data,t.state.columns=n.columns),n.pagination=u({},e.pagination)})}();return r&&r.then?r.then(function(){return n}):n})}catch(e){return Promise.reject(e)}}(e,r)).then(function(e){o=e}):Promise.resolve(function(e,n){try{var r=n.store,o=n.tableSummary,s=n.appControl.table,a=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(t(r,o,a,null,{qs:{start:e.from-1,limit:e.count,format:null==e.format&&e.format}})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(v(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,r)).then(function(e){o=e});return Promise.resolve(s&&s.then?s.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},d=function(e,n){try{var r,o="cas"===n.source?Promise.resolve(function(e,t){try{var n,r=t.appControl,o=r.table;if("first"===e)(n=u({},r.initialFetch)).table=o;else if(-1===(n=t.state.pagination[e]).next)return Promise.resolve(null);return console.log(n),Promise.resolve(p(n,t)).then(function(e){return e})}catch(e){return Promise.reject(e)}}(e,n)).then(function(e){r=e}):Promise.resolve(function(e,n){try{var r=n.store,o=n.tableSummary,s=n.appControl.table,a=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(t(r,o,a,e,{qs:{limit:n.appControl.initialFetch.count}})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(v(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,n)).then(function(e){r=e});return Promise.resolve(o&&o.then?o.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},P=function(e,t,n){try{var u,i=a();null==e.authType&&(e.authType="code");var l="cas"===t.source?Promise.resolve(function(e,t,n){try{return Promise.resolve(s(e,t)).then(function(r){return{source:n.source,store:e,session:r.session,servers:r.servers,restaflib:null,logonPayload:t,appControl:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})}catch(e){return Promise.reject(e)}}(i,e,t)).then(function(e){u=e}):Promise.resolve(function(e,t,n,s){try{return Promise.resolve(r(e,n.computeContext,t)).then(function(r){return Promise.resolve(o(e,r,n.table,s)).then(function(o){return{source:n.source,store:e,session:r,tableSummary:o,servers:null,restaflib:null,logonPayload:t,appControl:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(e){return Promise.reject(e)}}(i,e,t,n)).then(function(e){u=e});return Promise.resolve(l&&l.then?l.then(function(){return u}):u)}catch(e){return Promise.reject(e)}};export{f as cellEdit,i as commonHandler,p as fetchTableRows,d as scrollTable,P as setup,l as updateTableRows};
//# sourceMappingURL=index.module.js.map
