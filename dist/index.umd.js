!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@sassoftware/restaflib"),require("@sassoftware/restaf")):"function"==typeof define&&define.amd?define(["exports","@sassoftware/restaflib","@sassoftware/restaf"],n):n((e||self).restafedit={},e.restaflib,e.restaf)}(this,function(e,n,t){function r(){return r=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},r.apply(this,arguments)}var o=function(e,n,t,r){try{var o=r.appControl.editControl.handlers;return null==o[e]?Promise.resolve([n,{statusCode:0,msg:null}]):Promise.resolve(o[e](n,t,r,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}};function s(e,n,t){if(!e.s){if(t instanceof a){if(!t.s)return void(t.o=s.bind(null,e,n));1&n&&(n=t.s),t=t.v}if(t&&t.then)return void t.then(s.bind(null,e,n),s.bind(null,e,2));e.s=n,e.v=t;var r=e.o;r&&r(e)}}var i=function(e,n,t){try{var r=t.data,o=t.table,s=t.where,i="proc sql; update "+o.libref+"."+o.name,a="SET ",u=" ";for(var l in r)a=a+u+l+"="+c(r[l]),u=", ";i=i+" "+a;var f=" WHERE ",h=" ";for(var v in s)f=f+h+v+"= "+c(s[v])+" ",h=" AND ";var d={data:{code:(i=i+" "+f+";run;").split(/\r?\n/)}};return Promise.resolve(e.apiCall(n.links("execute"),d)).then(function(n){return Promise.resolve(e.jobState(n,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}};const a=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,t){const r=new e,o=this.s;if(o){const e=1&o?n:t;if(e){try{s(r,1,e(this.v))}catch(e){s(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?s(r,1,n?n(o):o):t?s(r,1,t(o)):s(r,2,o)}catch(e){s(r,2,e)}},r},e}();var u=function(e,t){try{var r=t.store,o=t.session,s="cas"===t.source?n.casUpdateData:i,a=function(e,n){var t=n.appControl,r=t.table,o=t.byvars,s=n.state.columns,i={};for(var a in e)"_index_"!==a&&"_rowIndex"!==a&&!1===s[a].custom&&(i[a]=e[a]);var u={};return o.forEach(function(e){u[e]=i[e]}),{table:r,data:i,where:u}}(e,t);return Promise.resolve(s(r,o,a))}catch(e){return Promise.reject(e)}},l=function(e,n){try{var t,r=n.appControl.byvars;if(null===r||0===r.length)return Promise.resolve([null,{msg:"Error: Please specify a by variable",statusCode:1}]);var o=function(){if(!0!==Array.isArray(e))return Promise.resolve(u(e,n)).then(function(e){t=e});var r,o,i,l,c,f=(r=e,o=function(r){return Promise.resolve(u(e[r],n)).then(function(e){t=e})},c=-1,function e(n){try{for(;++c<r.length;)if((n=o(c))&&n.then){if(!((t=n)instanceof a&&1&t.s))return void n.then(e,l||(l=s.bind(null,i=new a,2)));n=n.v}i?s(i,1,n):i=n}catch(e){s(i||(i=new a),2,e)}var t}(),i);return f&&f.then?f.then(function(){}):void 0}();return Promise.resolve(o&&o.then?o.then(function(){return t}):t)}catch(e){return Promise.reject(e)}};function c(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}function f(e,n,t){if(!e.s){if(t instanceof v){if(!t.s)return void(t.o=f.bind(null,e,n));1&n&&(n=t.s),t=t.v}if(t&&t.then)return void t.then(f.bind(null,e,n),f.bind(null,e,2));e.s=n,e.v=t;var r=e.o;r&&r(e)}}var h=function(e,n){try{var t=function(){var e={};if(s.forEach(function(n,t){var r=n.Column.toLowerCase();n.name=r,n.Label=null==n.Label||0===n.Label.length?n.Column:n.Label,null==n.Type&&(n.Type=null==n.type?"double":n.type),n.custom=!1,e[r]=n}),null!=a)for(var n in a){var t=r({},a[n]);t.name=n,t.custom=!0,e[n]=t}return{columns:e,data:l,status:u}},s=e.schema,i=e.rows,a=n.appControl.customColumns,u={statusCode:0,msg:"Initialization was successful"},l=[],c=(h=i,d=function(e){var t=function(e,n,t){var r={_rowIndex:t};if(n.forEach(function(n,t){var o=e[t].Column.toLowerCase();r[o]=n}),null!=a)for(var o in a){var s=a[o],i=s.Column.toLowerCase();r[i]=s.value}return r}(s,i[e],e);return Promise.resolve(o("init",t,e,n)).then(function(e){u=e[1],l.push(e[0])})},P=-1,function e(n){try{for(;++P<h.length;)if((n=d(P))&&n.then){if(!((t=n)instanceof v&&1&t.s))return void n.then(e,p||(p=f.bind(null,m=new v,2)));n=n.v}m?f(m,1,n):m=n}catch(e){f(m||(m=new v),2,e)}var t}(),m);return Promise.resolve(c&&c.then?c.then(t):t())}catch(e){return Promise.reject(e)}var h,d,m,p,P};const v=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,t){const r=new e,o=this.s;if(o){const e=1&o?n:t;if(e){try{f(r,1,e(this.v))}catch(e){f(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?f(r,1,n?n(o):o):t?f(r,1,t(o)):f(r,2,o)}catch(e){f(r,2,e)}},r},e}();function d(e,n,t){if(!e.s){if(t instanceof m){if(!t.s)return void(t.o=d.bind(null,e,n));1&n&&(n=t.s),t=t.v}if(t&&t.then)return void t.then(d.bind(null,e,n),d.bind(null,e,2));e.s=n,e.v=t;var r=e.o;r&&r(e)}}const m=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,t){const r=new e,o=this.s;if(o){const e=1&o?n:t;if(e){try{d(r,1,e(this.v))}catch(e){d(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?d(r,1,n?n(o):o):t?d(r,1,t(o)):d(r,2,o)}catch(e){d(r,2,e)}},r},e}();function p(e){return e instanceof m&&1&e.s}e.cellEdit=function(e,n,t,s,i){try{var a,u=function(e){return a?e:Promise.resolve(o("main",c,t,i)).then(function(e){var n;function r(t){return n?t:(c=e[0],!0===m&&(i.state.data[s._rowIndex]=c),{data:c,status:p})}var a=function(){if(!0===d)return Promise.resolve(o("term",e[0],t,i)).then(function(t){return 2===(p=(e=t)[1]).statusCode?(n=1,{data:e[0],status:p}):Promise.resolve(l(e[0],i)).then(function(e){p=e})})}();return a&&a.then?a.then(r):r(a)})},c=r({},s),f=i.appControl.editControl,h=f.handlers,v=f.autoSave,d=null==v||v,m=null==i.appControl.cachePolicy||i.appControl.cachePolicy;c[e]=function(e,n){var t=e,r=n.Type.toLowerCase();return"string"!=typeof t||"decimal"!==r&&"number"!==r&&"double"!==r&&"float"!==r||(t=parseFloat(1*e),!0===isNaN(e)&&(e=0)),t}(n,i.state.columns[e]);var p={statusCode:0,msg:""},P=function(){if(null!=h[e])return Promise.resolve(h[e](c,e,t,i)).then(function(e){if(c=e[0],2===(p=e[1]).statusCode)return a=1,{data:e[0],status:p}})}();return Promise.resolve(P&&P.then?P.then(u):u(P))}catch(e){return Promise.reject(e)}},e.commonHandler=o,e.distinctValues=function(e,t,r){try{var o,s=null!=r?r:t.appControl.table,i="cas"===t.source?Promise.resolve(function(e,t,r){try{return Promise.resolve(n.caslRun(r.store,r.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:e,column:t},!0)).then(function(e){if(0!==e.results.casResults.data.statusCode)throw"Failed to create unique list";return e.results.casResults.data.data})}catch(e){return Promise.reject(e)}}(s,e,t)).then(function(e){o=e}):Promise.resolve(function(e,t,r){try{var o=r.store;return Promise.resolve(n.computeRun(o,r.session,"\n    PROC SQL;\n    CREATE TABLE WORK.QUERY\n    AS\n    SELECT distinct("+t+") as utype FROM "+e.libref+"."+e.name+";\n   QUIT;")).then(function(e){function r(){return i[t]=u,i}var s,i={},a="first",u=[],l=function(e,n){var t;do{var r=e();if(r&&r.then){if(!p(r)){t=!0;break}r=r.v}var o=n();if(p(o)&&(o=o.v),!o)return r}while(!o.then);var s=new m,i=d.bind(null,s,2);return(t?r.then(a):o.then(u)).then(void 0,i),s;function a(t){for(r=t;p(o=n())&&(o=o.v),o;){if(o.then)return void o.then(u).then(void 0,i);if((r=e())&&r.then){if(!p(r))return void r.then(a).then(void 0,i);r=r.v}}d(s,1,r)}function u(t){if(t){do{if((r=e())&&r.then){if(!p(r))return void r.then(a).then(void 0,i);r=r.v}if(p(t=n())&&(t=t.v),!t)return void d(s,1,r)}while(!t.then);t.then(u).then(void 0,i)}else d(s,1,r)}}(function(){return Promise.resolve(n.computeFetchData(o,e,"QUERY",a)).then(function(e){var n=(s=e).rows.map(function(e){return e[0]});u.push.apply(u,n),a="next"})},function(){return s.scrollOptions.indexOf("next")>=0});return l&&l.then?l.then(r):r()})}catch(e){return Promise.reject(e)}}(s,e,t)).then(function(e){o=e});return Promise.resolve(i&&i.then?i.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},e.saveTable=function(e,t){try{var r=e.store,o=e.session;return"compute"===e.source?Promise.resolve({msg:"Action does not apply to SAS 9 tables",statusCode:0}):Promise.resolve(n.casSaveTable(r,o,null!=t?t:e.appControl.table)).then(function(){return{msg:"Table saved",statusCode:0}})}catch(e){return Promise.reject(e)}},e.scrollTable=function(e,t,o){try{var s,i="cas"===t.source?Promise.resolve(function(e,t,o){try{var s,i=t.store,a=t.session,u=t.appControl,l=u.initialFetch,c=u.table,f=null==t.appControl.cachePolicy||t.appControl.cachePolicy;if(null!=o)s=r({},o);else if("first"===e)s=r({},l);else if(null!==e&&(-1===(s=r({},t.state.pagination[e])).next||s.from<=0))return Promise.resolve(null);var v={};return null!=s.qs?((v=r({},s.qs)).from=v.start+1,v.count=v.limit):v=r({},s),v.from<=0||-1===v.next?Promise.resolve(null):(null==v.where&&(v.where=" "),v.table=c,Promise.resolve(n.casFetchRows(i,a,v)).then(function(e){var n=null;return function(){if(null!==e)return Promise.resolve(h(e.data,t)).then(function(o){return n=o,t.state={modified:[],pagination:r({},e.pagination),currentPage:s,data:[],columns:[]},!0===f&&(t.state.data=n.data,t.state.columns=n.columns),n.pagination=r({},e.pagination),n})}()}))}catch(e){return Promise.reject(e)}}(e,t,o)).then(function(e){s=e}):Promise.resolve(function(e,t,o){try{var s=t.store,i=t.tableSummary,a=t.appControl,u=a.table,l=a.initialFetch,c=null==t.appControl.cachePolicy||t.appControl.cachePolicy,f=null,v=(u.libref+"."+u.name).toLowerCase();return null==o?"first"===e&&(f=r({},l)):f=r({},o),Promise.resolve(n.computeFetchData(s,i,v,e,f)).then(function(e){var n=null,r=function(){if(null!==e)return Promise.resolve(h(e,t)).then(function(e){n=e,t.state={modified:[],pagination:{},currentPage:{},data:[],columns:[]},!0===c&&(t.state.data=n.data,t.state.columns=n.columns)})}();return r&&r.then?r.then(function(){return n}):n})}catch(e){return Promise.reject(e)}}(e,t,o)).then(function(e){s=e});return Promise.resolve(i&&i.then?i.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},e.setup=function(e,r){try{var o,s=function(){console.log(r.editControl.handlers.fseinit);var e=function(){if(null!=r.editControl.handlers.fseinit)return Promise.resolve(r.editControl.handlers.fseinit(o,"fseinit")).then(function(e){if(2===e.statusCode)throw console.log(JSON.stringify(e,null,4)),"fseinit failed. Please see console"})}();return e&&e.then?e.then(function(e){return o}):o},i=t.initStore();null==e.authType&&(e.authType="code");var a="cas"===r.source?Promise.resolve(function(e,t,r){try{return Promise.resolve(n.casSetup(e,t)).then(function(o){var s=null!=r.editControl.handlers.fseinit?null:r.preamble,i={source:r.source,store:e,session:o.session,servers:o.servers,restaflib:null,logonPayload:t,appControl:r,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},a=function(){if(null!==s)return Promise.resolve(n.caslRun(e,o.session,s)).then(function(e){if(0!==e.disposition.statusCode)throw console.log(JSON.stringify(e,null,4)),"Preamble failed. Please see console"})}();return a&&a.then?a.then(function(e){return i}):i})}catch(e){return Promise.reject(e)}}(i,e,r)).then(function(e){o=e}):Promise.resolve(function(e,t,r){try{var o=null!=r.editControl.handlers.fseinit?null:r.preamble;return Promise.resolve(n.computeSetup(e,r.computeContext,t)).then(function(s){function i(t){return Promise.resolve(n.computeSetupTables(e,s,r.table,o)).then(function(e){return a.tableSummary=e,a})}var a={source:r.source,store:e,session:s,servers:null,restaflib:null,logonPayload:t,appControl:r,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},u=function(){if(null!=r.editControl.handlers.fseinit)return Promise.resolve(r.editControl.handlers.fseinit(a,"fseinit")).then(function(e){if(2===e.statusCode)throw console.log(JSON.stringify(e,null,4)),"fseinit failed. Please see console"})}();return u&&u.then?u.then(i):i()})}catch(e){return Promise.reject(e)}}(i,e,r)).then(function(e){o=e});return Promise.resolve(a&&a.then?a.then(s):s())}catch(e){return Promise.reject(e)}},e.termSession=async function(e,n){const{store:t,session:r}=e,o=e.appControl.editControl.handlers;return null!=o.fseterm&&await o.fseterm(e),!1!==n&&await t.apiCall(r.links("delete")),{msg:"Session terminated",statusCode:0}},e.updateTableRows=l,e.uploadData=function(e,t,o,s,i,a,u){try{var l=i.store,c=i.session;null===t&&(t=i.state.data);var f=Object.keys(t[0]),h=["_index_","_rowIndex"];null!==o&&(h=h.concat(o));var v=f.filter(function(e){return!(h.indexOf(e)>=0)}),d={};v.forEach(function(e){d[e]=i.state.columns[e]});var m=null;"cas"===i.source&&(m=v.join(",")+"\n");for(var p,P=function(e){var n=t[e];n=r({},n,s);var o=[];v.forEach(function(e,t){var r=n[e];"string"==typeof r&&(r=r.trim()),o[t]=r}),m=null===m?o.join(",")+"\n":m+o.join(",")+"\n"},y=0;y<t.length;y++)P(y);var b="cas"===i.source?Promise.resolve(function(e,t,r,o,s,i){try{return Promise.resolve(n.casUpload(e,t,null,r.caslib+"."+r.name,!0,o)).then(function(o){return null!=s?Promise.resolve(n.casAppendTable(e,t,r,s,i)).then(function(e){return o=e}):o})}catch(e){return Promise.reject(e)}}(l,c,e,m,a,u)).then(function(e){p=e}):Promise.resolve(function(e,t,r,o,s){try{var i="data "+o.libref+"."+o.name+"; INFILE datalines delimiter=',' ;\n",a="",u="INPUT ";for(var l in r){var c=r[l];u=u+c.Column+" ","CHAR"===c.Type&&(a=a+"  "+c.Column+" $ "+c.length+" \n")}return a.length>0&&(a="LENGTH "+a+";\n"),i=i+";\n"+a+(u+=";\n")+"datalines;\n"+s+"\n; run; proc print;run;\n",Promise.resolve(n.computeRun(e,t,i)).then(function(){return{msg:"done",statusCode:0}})}catch(e){return Promise.reject(e)}}(l,c,d,e,m)).then(function(e){p=e});return Promise.resolve(b&&b.then?b.then(function(){return p}):p)}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=index.umd.js.map
