import{casUpdateData as n,computeFetchData as t,casFetchRows as e,computeSetup as r,computeSetupTables as o,casSetup as i,caslRun as s,computeRun as u,casUpload as a,casAppendTable as l,casSaveTable as c}from"@sassoftware/restaflib";import{initStore as f}from"@sassoftware/restaf";function h(){return h=Object.assign?Object.assign.bind():function(n){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r])}return n},h.apply(this,arguments)}var v=function(n,t,e,r){try{var o=r.appControl.editControl.handlers;return null==o[n]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[n](t,e,r,n)).then(function(n){return[n[0],n[1]]})}catch(n){return Promise.reject(n)}};function m(n,t,e){if(!n.s){if(e instanceof p){if(!e.s)return void(e.o=m.bind(null,n,t));1&t&&(t=e.s),e=e.v}if(e&&e.then)return void e.then(m.bind(null,n,t),m.bind(null,n,2));n.s=t,n.v=e;var r=n.o;r&&r(n)}}var d=function(n,t,e){try{var r=e.data,o=e.table,i=e.where,s="proc sql; update "+o.libref+"."+o.name,u="SET ",a=" ";for(var l in r)u=u+a+l+"="+b(r[l]),a=", ";s=s+" "+u;var c=" WHERE ",f=" ";for(var h in i)c=c+f+h+"= "+b(i[h])+" ",f=" AND ";var v={data:{code:(s=s+" "+c+";run;").split(/\r?\n/)}};return Promise.resolve(n.apiCall(t.links("execute"),v)).then(function(t){return Promise.resolve(n.jobState(t,{qs:{newState:"Completed",timeout:1}})).then(function(n){return{statusCode:"completed"===n.data?0:1,msg:n.data}})})}catch(n){return Promise.reject(n)}};const p=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(t,e){const r=new n,o=this.s;if(o){const n=1&o?t:e;if(n){try{m(r,1,n(this.v))}catch(n){m(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?m(r,1,t?t(o):o):e?m(r,1,e(o)):m(r,2,o)}catch(n){m(r,2,n)}},r},n}();var P=function(t,e){try{var r=e.store,o=e.session,i="cas"===e.source?n:d,s=function(n,t){var e=t.appControl,r=e.table,o=e.byvars,i=t.state.columns,s={};for(var u in n)"_index_"!==u&&"_rowIndex"!==u&&!1===i[u].custom&&(s[u]=n[u]);var a={};return o.forEach(function(n){a[n]=s[n]}),{table:r,data:s,where:a}}(t,e);return Promise.resolve(i(r,o,s))}catch(n){return Promise.reject(n)}},y=function(n,t){try{var e,r=t.appControl.byvars;if(null===r||0===r.length)return Promise.resolve([null,{msg:"Error: Please specify a by variable",statusCode:1}]);var o=function(){if(!0!==Array.isArray(n))return Promise.resolve(P(n,t)).then(function(n){e=n});var r,o,i,s,u,a=(r=n,o=function(r){return Promise.resolve(P(n[r],t)).then(function(n){e=n})},u=-1,function n(t){try{for(;++u<r.length;)if((t=o(u))&&t.then){if(!((e=t)instanceof p&&1&e.s))return void t.then(n,s||(s=m.bind(null,i=new p,2)));t=t.v}i?m(i,1,t):i=t}catch(n){m(i||(i=new p),2,n)}var e}(),i);return a&&a.then?a.then(function(){}):void 0}();return Promise.resolve(o&&o.then?o.then(function(){return e}):e)}catch(n){return Promise.reject(n)}};function b(n){return null==n?".":"string"==typeof n?JSON.stringify(n):n.toString()}var C=function(n,t,e,r,o){try{var i,s=function(n){return i?n:Promise.resolve(v("main",u,e,o)).then(function(n){var t;function i(e){return t?e:(u=n[0],!0===m&&(o.state.data[r._rowIndex]=u),{data:u,status:d})}var s=function(){if(!0===f)return Promise.resolve(v("term",n[0],e,o)).then(function(e){return 2===(d=(n=e)[1]).statusCode?(t=1,{data:n[0],status:d}):Promise.resolve(y(n[0],o)).then(function(n){d=n})})}();return s&&s.then?s.then(i):i(s)})},u=h({},r),a=o.appControl.editControl,l=a.handlers,c=a.autoSave,f=null==c||c,m=null==o.appControl.cachePolicy||o.appControl.cachePolicy;u[n]=function(n,t){var e=n,r=t.Type.toLowerCase();return"string"!=typeof e||"decimal"!==r&&"number"!==r&&"double"!==r&&"float"!==r||(e=parseFloat(1*n),!0===isNaN(n)&&(n=0)),e}(t,o.state.columns[n]);var d={statusCode:0,msg:""},p=function(){if(null!=l[n])return Promise.resolve(l[n](u,n,e,o)).then(function(n){if(u=n[0],2===(d=n[1]).statusCode)return i=1,{data:n[0],status:d}})}();return Promise.resolve(p&&p.then?p.then(s):s(p))}catch(n){return Promise.reject(n)}};function g(n,t,e){if(!n.s){if(e instanceof j){if(!e.s)return void(e.o=g.bind(null,n,t));1&t&&(t=e.s),e=e.v}if(e&&e.then)return void e.then(g.bind(null,n,t),g.bind(null,n,2));n.s=t,n.v=e;var r=n.o;r&&r(n)}}var w=function(n,t){try{var e=function(){var n={};if(r.forEach(function(t,e){var r=t.Column.toLowerCase();t.name=r,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,n[r]=t}),null!=i)for(var t in i){var e=h({},i[t]);e.name=t,e.custom=!0,n[t]=e}return{columns:n,data:u,status:s}},r=n.schema,o=n.rows,i=t.appControl.customColumns,s={statusCode:0,msg:"Initialization was successful"},u=[],a=(l=o,c=function(n){var e=function(n,t,e){var r={_rowIndex:e};if(t.forEach(function(t,e){var o=n[e].Column.toLowerCase();r[o]=t}),null!=i)for(var o in i){var s=i[o],u=s.Column.toLowerCase();r[u]=s.value}return r}(r,o[n],n);return Promise.resolve(v("init",e,n,t)).then(function(n){s=n[1],u.push(n[0])})},d=-1,function n(t){try{for(;++d<l.length;)if((t=c(d))&&t.then){if(!((e=t)instanceof j&&1&e.s))return void t.then(n,m||(m=g.bind(null,f=new j,2)));t=t.v}f?g(f,1,t):f=t}catch(n){g(f||(f=new j),2,n)}var e}(),f);return Promise.resolve(a&&a.then?a.then(e):e())}catch(n){return Promise.reject(n)}var l,c,f,m,d};const j=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(t,e){const r=new n,o=this.s;if(o){const n=1&o?t:e;if(n){try{g(r,1,n(this.v))}catch(n){g(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?g(r,1,t?t(o):o):e?g(r,1,e(o)):g(r,2,o)}catch(n){g(r,2,n)}},r},n}();var E=function(n,r){try{return Promise.resolve("cas"===r.source?function(n,t){try{var r=t.store,o=t.session,i={};return null!=n.qs?((i=h({},n.qs)).from=i.start+1,i.count=i.limit):i=h({},n),i.from<=0||-1===i.next?Promise.resolve(null):(null==i.where&&(i.where=" "),Promise.resolve(e(r,o,i)).then(function(n){var e=null,r=function(){if(null!==n)return Promise.resolve(w(n.data,t)).then(function(r){e=r,t.state={modified:[],pagination:h({},n.pagination),currentPage:i,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=e.data,t.state.columns=e.columns),e.pagination=h({},n.pagination)})}();return r&&r.then?r.then(function(){return e}):e}))}catch(n){return Promise.reject(n)}}(n,r):function(n,e){try{var r=e.store,o=e.tableSummary,i=e.appControl.table,s=(i.libref+"."+i.name).toLowerCase();return Promise.resolve(t(r,o,s,null,{qs:{start:n.from-1,limit:n.count,format:null==n.format&&n.format}})).then(function(n){var t=null,r=function(){if(null!==n)return Promise.resolve(w(n,e)).then(function(n){e.state={modified:[],pagination:{},currentPage:{},data:(t=n).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(n){return Promise.reject(n)}}(n,r))}catch(n){return Promise.reject(n)}},x=function(n,r,o){try{var i,s="cas"===r.source?Promise.resolve(function(n,t,r){try{var o,i=t.store,s=t.session,u=t.appControl,a=u.initialFetch,l=u.table,c=null==t.appControl.cachePolicy||t.appControl.cachePolicy;if(null!=r)o=h({},r);else if("first"===n)o=h({},a);else if(null!==n&&(-1===(o=h({},t.state.pagination[n])).next||o.from<=0))return Promise.resolve(null);var f={};return null!=o.qs?((f=h({},o.qs)).from=f.start+1,f.count=f.limit):f=h({},o),f.from<=0||-1===f.next?Promise.resolve(null):(null==f.where&&(f.where=" "),f.table=l,Promise.resolve(e(i,s,f)).then(function(n){var e=null;return function(){if(null!==n)return Promise.resolve(w(n.data,t)).then(function(r){return e=r,t.state={modified:[],pagination:h({},n.pagination),currentPage:o,data:[],columns:[]},!0===c&&(t.state.data=e.data,t.state.columns=e.columns),e.pagination=h({},n.pagination),e})}()}))}catch(n){return Promise.reject(n)}}(n,r,o)).then(function(n){i=n}):Promise.resolve(function(n,e,r){try{var o=e.store,i=e.tableSummary,s=e.appControl,u=s.table,a=s.initialFetch,l=null==e.appControl.cachePolicy||e.appControl.cachePolicy,c=null,f=(u.libref+"."+u.name).toLowerCase();return null==r?"first"===n&&(c=h({},a)):c=h({},r),Promise.resolve(t(o,i,f,n,c)).then(function(n){var t=null,r=function(){if(null!==n)return Promise.resolve(w(n,e)).then(function(n){t=n,e.state={modified:[],pagination:{},currentPage:{},data:[],columns:[]},!0===l&&(e.state.data=t.data,e.state.columns=t.columns)})}();return r&&r.then?r.then(function(){return t}):t})}catch(n){return Promise.reject(n)}}(n,r,o)).then(function(n){i=n});return Promise.resolve(s&&s.then?s.then(function(){return i}):i)}catch(n){return Promise.reject(n)}},L=function(n,t){try{var e,u=f();null==n.authType&&(n.authType="code");var a="cas"===t.source?Promise.resolve(function(n,t,e){try{return Promise.resolve(i(n,t)).then(function(r){var o={source:e.source,store:n,session:r.session,servers:r.servers,restaflib:null,logonPayload:t,appControl:e,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},i=function(){if(null!=e.preamble)return Promise.resolve(s(n,r.session,e.preamble)).then(function(n){if(0!==n.disposition.statusCode)throw console.log(JSON.stringify(n,null,4)),"Preamble failed. Please see console"})}();return i&&i.then?i.then(function(n){return o}):o})}catch(n){return Promise.reject(n)}}(u,n,t)).then(function(n){e=n}):Promise.resolve(function(n,t,e){try{return Promise.resolve(r(n,e.computeContext,t)).then(function(r){return Promise.resolve(o(n,r,e.table,e.preamble)).then(function(o){return{source:e.source,store:n,session:r,tableSummary:o,servers:null,restaflib:null,logonPayload:t,appControl:e,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(n){return Promise.reject(n)}}(u,n,t)).then(function(n){e=n});return Promise.resolve(a&&a.then?a.then(function(){return e}):e)}catch(n){return Promise.reject(n)}};function S(n,t,e){if(!n.s){if(e instanceof _){if(!e.s)return void(e.o=S.bind(null,n,t));1&t&&(t=e.s),e=e.v}if(e&&e.then)return void e.then(S.bind(null,n,t),S.bind(null,n,2));n.s=t,n.v=e;var r=n.o;r&&r(n)}}const _=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(t,e){const r=new n,o=this.s;if(o){const n=1&o?t:e;if(n){try{S(r,1,n(this.v))}catch(n){S(r,2,n)}return r}return this}return this.o=function(n){try{const o=n.v;1&n.s?S(r,1,t?t(o):o):e?S(r,1,e(o)):S(r,2,o)}catch(n){S(r,2,n)}},r},n}();function T(n){return n instanceof _&&1&n.s}var O=function(n,e,r){try{var o,i=null!=r?r:e.appControl.table,a="cas"===e.source?Promise.resolve(function(n,t,e){try{return Promise.resolve(s(e.store,e.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:n,column:t},!0)).then(function(n){if(0!==n.results.casResults.data.statusCode)throw"Failed to create unique list";return n.results.casResults.data.data})}catch(n){return Promise.reject(n)}}(i,n,e)).then(function(n){o=n}):Promise.resolve(function(n,e,r){try{var o=r.store;return Promise.resolve(u(o,r.session,"\n    PROC SQL;\n    CREATE TABLE WORK.QUERY\n    AS\n    SELECT distinct("+e+") as utype FROM "+n.libref+"."+n.name+";\n   QUIT;")).then(function(n){function r(){return s[e]=a,s}var i,s={},u="first",a=[],l=function(n,t){var e;do{var r=n();if(r&&r.then){if(!T(r)){e=!0;break}r=r.v}var o=t();if(T(o)&&(o=o.v),!o)return r}while(!o.then);var i=new _,s=S.bind(null,i,2);return(e?r.then(u):o.then(a)).then(void 0,s),i;function u(e){for(r=e;T(o=t())&&(o=o.v),o;){if(o.then)return void o.then(a).then(void 0,s);if((r=n())&&r.then){if(!T(r))return void r.then(u).then(void 0,s);r=r.v}}S(i,1,r)}function a(e){if(e){do{if((r=n())&&r.then){if(!T(r))return void r.then(u).then(void 0,s);r=r.v}if(T(e=t())&&(e=e.v),!e)return void S(i,1,r)}while(!e.then);e.then(a).then(void 0,s)}else S(i,1,r)}}(function(){return Promise.resolve(t(o,n,"QUERY",u)).then(function(n){var t=(i=n).rows.map(function(n){return n[0]});a.push.apply(a,t),u="next"})},function(){return i.scrollOptions.indexOf("next")>=0});return l&&l.then?l.then(r):r()})}catch(n){return Promise.reject(n)}}(i,n,e)).then(function(n){o=n});return Promise.resolve(a&&a.then?a.then(function(){return o}):o)}catch(n){return Promise.reject(n)}},R=function(n,t,e,r,o,i,s){try{var c=o.store,f=o.session;null===t&&(t=o.state.data);var v=Object.keys(t[0]),m=["_index_","_rowIndex"];null!==e&&(m=m.concat(e));var d=v.filter(function(n){return!(m.indexOf(n)>=0)}),p={};d.forEach(function(n){p[n]=o.state.columns[n]});var P=null;"cas"===o.source&&(P=d.join(",")+"\n");for(var y,b=function(n){var e=t[n];e=h({},e,r);var o=[];d.forEach(function(n,t){var r=e[n];"string"==typeof r&&(r=r.trim()),o[t]=r}),P=null===P?o.join(",")+"\n":P+o.join(",")+"\n"},C=0;C<t.length;C++)b(C);var g="cas"===o.source?Promise.resolve(function(n,t,e,r,o,i){try{return Promise.resolve(a(n,t,null,e.caslib+"."+e.name,!0,r)).then(function(r){return null!=o?Promise.resolve(l(n,t,e,o,i)).then(function(n){return r=n}):r})}catch(n){return Promise.reject(n)}}(c,f,n,P,i,s)).then(function(n){y=n}):Promise.resolve(function(n,t,e,r,o){try{var i="data "+r.libref+"."+r.name+"; INFILE datalines delimiter=',' ;\n",s="",a="INPUT ";for(var l in e){var c=e[l];a=a+c.Column+" ","CHAR"===c.Type&&(s=s+"  "+c.Column+" $ "+c.length+" \n")}return s.length>0&&(s="LENGTH "+s+";\n"),i=i+";\n"+s+(a+=";\n")+"datalines;\n"+o+"\n; run; proc print;run;\n",Promise.resolve(u(n,t,i)).then(function(){return{msg:"done",statusCode:0}})}catch(n){return Promise.reject(n)}}(c,f,p,n,P)).then(function(n){y=n});return Promise.resolve(g&&g.then?g.then(function(){return y}):y)}catch(n){return Promise.reject(n)}},A=function(n,t){try{var e=n.store,r=n.session;return"compute"===n.source?Promise.resolve({msg:"Action does not apply to SAS 9 tables",statusCode:0}):Promise.resolve(c(e,r,null!=t?t:n.appControl.table)).then(function(){return{msg:"Table saved",statusCode:0}})}catch(n){return Promise.reject(n)}};export{C as cellEdit,v as commonHandler,O as distinctValues,E as fetchTableRows,A as saveTable,x as scrollTable,L as setup,y as updateTableRows,R as uploadData};
//# sourceMappingURL=index.module.js.map
