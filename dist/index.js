var e=require("@sassoftware/restaflib"),t=require("@sassoftware/restaf");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=/*#__PURE__*/r(require("deepmerge"));function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o.apply(this,arguments)}var s=function(e,t,r,n){try{var o=n.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,r,n,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}},a=function(t,r){try{var n,o="cas"===r.source?Promise.resolve(function(t,r){try{var n=r.store,o=r.session,s=r.appControl,a=s.table,u=s.byvars,i=r.state.columns;if(null===u||0===u.length)return Promise.resolve(null);var c={};for(var l in t)"_index_"!==l&&"_rowIndex"!==l&&!1===i[l].custom&&(c[l]=t[l]);var f={};return u.forEach(function(e){f[e]=c[e]}),Promise.resolve(e.casUpdateData(n,o,{table:a,data:c,where:f})).then(function(e){var t={statusCode:0,msg:"Save successful"};return"Normal"!==e.items().toJS().disposition.severity&&(t.statusCode=2,t.msg=c.disposition.severity.reason),t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e}):Promise.resolve(function(e,t){try{var r=t.store,n=t.session,o=t.appControl,s=o.table,a=o.byvars,i=t.state.columns;if(null===a||0===a.length)return Promise.resolve(null);var c="proc sql; update "+s.libref+"."+s.name,l="SET ",f=" ";for(var m in e)!1===i[m].custom&&(l=l+f+m+"="+u(e[m])),f=", ";c=c+" "+l;var v=" WHERE ",h=" ";a.forEach(function(t){v=v+h+t+"="+u(e[t]),h="AND "});var d={data:{code:(c=c+" "+v+";run;").split(/\r?\n/)}};return Promise.resolve(r.apiCall(n.links("execute"),d)).then(function(e){return Promise.resolve(r.jobState(e,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e});return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(e){return Promise.reject(e)}};function u(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}function i(e,t,r){if(!e.s){if(r instanceof l){if(!r.s)return void(r.o=i.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(i.bind(null,e,t),i.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var c=function(e,t){try{var r=function(){var e={};if(n.forEach(function(t,r){var n=t.Column.toLowerCase();t.name=n,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,e[n]=t}),null!=u)for(var t in u){var r=o({},u[t]);r.name=t,r.custom=!0,e[t]=r}return{columns:e,data:f,status:c}},n=e.schema,a=e.rows,u=t.appControl.customColumns,c={statusCode:0,msg:"Initialization was successful"},f=[],m=(v=a,h=function(e){var r=function(e,t,r){var n={_rowIndex:r};if(t.forEach(function(t,r){var o=e[r].Column.toLowerCase();n[o]=t}),null!=u)for(var o in u){var s=u[o],a=s.Column.toLowerCase();n[a]=s.value}return n}(n,a[e],e);return Promise.resolve(s("init",r,e,t)).then(function(e){c=e[1],f.push(e[0])})},P=-1,function e(t){try{for(;++P<v.length;)if((t=h(P))&&t.then){if(!((r=t)instanceof l&&1&r.s))return void t.then(e,p||(p=i.bind(null,d=new l,2)));t=t.v}d?i(d,1,t):d=t}catch(e){i(d||(d=new l),2,e)}var r}(),d);return Promise.resolve(m&&m.then?m.then(r):r())}catch(e){return Promise.reject(e)}var v,h,d,p,P};const l=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{i(n,1,e(this.v))}catch(e){i(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?i(n,1,t?t(o):o):r?i(n,1,r(o)):i(n,2,o)}catch(e){i(n,2,e)}},n},e}();var f=function(t,r,n,o,s,a){try{return console.log("calling casUpload"),Promise.resolve(e.casUpload(t,r,null,n.caslib+"."+n.name,!0,o)).then(function(o){return console.log("end of casUpload"),function(){if(null!=s)return Promise.resolve(e.casAppendTable(t,r,n,s,a)).then(function(e){return e})}()})}catch(e){return Promise.reject(e)}};exports.cellEdit=function(e,t,r,n,u){try{var i,c=function(e){return i?e:Promise.resolve(s("main",l,r,u)).then(function(e){var t;function o(r){return t?r:(l=e[0],!0===u.appControl.cachePolicy&&(u.state.data[n._rowIndex]=l),{data:l,status:h})}var i=function(){if(!0===v)return Promise.resolve(s("term",e[0],r,u)).then(function(r){return 2===(h=(e=r)[1]).statusCode?(t=1,{data:e[0],status:h}):Promise.resolve(a(e[0],u)).then(function(e){h=e})})}();return i&&i.then?i.then(o):o(i)})},l=o({},n),f=u.appControl.editControl,m=f.handlers,v=f.autoSave;l[e]=function(e,t){var r=e,n=t.Type.toLowerCase();return"string"!=typeof r||"decimal"!==n&&"number"!==n&&"double"!==n&&"float"!==n||(r=parseFloat(1*e),!0===isNaN(e)&&(e=0)),r}(t,u.state.columns[e]);var h={statusCode:0,msg:""},d=function(){if(null!=m[e])return Promise.resolve(m[e](l,e,r,u)).then(function(e){if(l=e[0],2===(h=e[1]).statusCode)return i=1,{data:e[0],status:h}})}();return Promise.resolve(d&&d.then?d.then(c):c(d))}catch(e){return Promise.reject(e)}},exports.commonHandler=s,exports.distinctValues=function(t,r,n,o){try{var s,a="cas"===n.source?Promise.resolve(function(t,r,n,o){try{return Promise.resolve(e.caslRun(n.store,n.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:t,column:r},!0)).then(function(e){if(0!==e.results.casResults.data.statusCode)throw"Failed to create unique list";return e.results.casResults.data.data})}catch(e){return Promise.reject(e)}}(t,r,n)).then(function(e){s=e}):Promise.resolve(function(e,t,r){try{var n={};return n[e]=[],Promise.resolve(n)}catch(e){return Promise.reject(e)}}(t)).then(function(e){s=e});return Promise.resolve(a&&a.then?a.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},exports.fetchTableRows=function(t,r){try{var n=null,s="cas"===r.source?Promise.resolve(function(t,r){try{var n=r.store,s=r.session,a=o({},t);return a.from<=0||-1===a.next?Promise.resolve(null):(null==a.where&&(a.where=" "),Promise.resolve(e.casFetchRows(n,s,a)).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(c(e.data,r)).then(function(n){t=n,r.state={modified:[],pagination:o({},e.pagination),currentPage:a,data:[],columns:[]},!0===r.appControl.cachePolicy&&(r.state.data=t.data,r.state.columns=t.columns),t.pagination=o({},e.pagination)})}();return n&&n.then?n.then(function(){return t}):t}))}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e}):Promise.resolve(function(t,r){try{var n=r.store,o=r.tableSummary,s=r.appControl.table,a=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(e.computeFetchData(n,o,a,null,{qs:{start:t.from-1,limit:t.count,format:null==t.format&&t.format}})).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(c(e,r)).then(function(e){r.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e});return Promise.resolve(s&&s.then?s.then(function(){return n}):n)}catch(e){return Promise.reject(e)}},exports.scrollTable=function(t,r,n){try{var s,a="cas"===r.source?Promise.resolve(function(t,r,n){try{var s,a=r.store,u=r.session,i=r.appControl,l=i.table;if("first"===t)s=o({},i.initialFetch);else if(null!==t&&(-1===(s=o({},r.state.pagination[t])).next||s.from<=0))return Promise.resolve(null);return null!=n&&(s=o({},n)),s.table=l,Promise.resolve(e.casFetchRows(a,u,s)).then(function(e){var t=null;return function(){if(null!==e)return Promise.resolve(c(e.data,r)).then(function(n){return t=n,r.state={modified:[],pagination:o({},e.pagination),currentPage:s,data:[],columns:[]},!0===r.appControl.cachePolicy&&(r.state.data=t.data,r.state.columns=t.columns),t.pagination=o({},e.pagination),t})}()})}catch(e){return Promise.reject(e)}}(t,r,n)).then(function(e){s=e}):Promise.resolve(function(t,r,n){try{var s=r.store,a=r.tableSummary,u=r.appControl,i=u.table,l=u.initialFetch,f=null,m=(i.libref+"."+i.name).toLowerCase();return null==n?"first"===t&&(f=o({},l)):f=o({},n),Promise.resolve(e.computeFetchData(s,a,m,t,f)).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(c(e,r)).then(function(e){r.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(t,r,n)).then(function(e){s=e});return Promise.resolve(a&&a.then?a.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},exports.setup=function(r,o,s){try{var a,u=t.initStore();null==r.authType&&(r.authType="code");var i="cas"===o.source?Promise.resolve(function(t,r,n){try{return Promise.resolve(e.casSetup(t,r)).then(function(e){return{source:n.source,store:t,session:e.session,servers:e.servers,restaflib:null,logonPayload:r,appControl:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})}catch(e){return Promise.reject(e)}}(u,r,o)).then(function(e){a=e}):Promise.resolve(function(t,r,o,s){try{return Promise.resolve(e.computeSetup(t,o.computeContext,r)).then(function(a){return Promise.resolve(e.computeSetupTables(t,a,o.table,s)).then(function(e){return{source:o.source,store:t,session:a,tableSummary:e,servers:null,restaflib:null,logonPayload:r,appControl:n.default(o),state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(e){return Promise.reject(e)}}(u,r,o,s)).then(function(e){a=e});return Promise.resolve(i&&i.then?i.then(function(){return a}):a)}catch(e){return Promise.reject(e)}},exports.sort=function(e,t,r){return Promise.resolve([])},exports.updateTableRows=a,exports.uploadData=function(t,r,n,s,a,u,i){try{for(var c=function(){return d},l=a.store,m=a.session,v=r[0],h=0;h<n.length;h++)delete v[n[h]];v=o({},s,v);for(var d,p=Object.keys(v),P=p.join(",")+"\n",y=function(e){var t=r[e];t=o({},t,s);var n=[];p.forEach(function(e,r){var o=t[e];"string"==typeof o&&(o=o.trim()),n[r]=o}),P=P+n.join(",")+"\n"},g=0;g<r.length;g++)y(g);console.log(P),console.log(e.casUpload),console.log(f);var b=function(){if("cas"===a.source)return Promise.resolve(f(l,m,t,P,u,i)).then(function(e){d=e});d={}}();return Promise.resolve(b&&b.then?b.then(c):c())}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=index.js.map
