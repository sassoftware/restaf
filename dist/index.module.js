import{casUpdateData as t,casFetchRows as n,casSetup as e}from"@sassoftware/restaflib";import{initStore as r}from"@sassoftware/restaf";function o(){return o=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},o.apply(this,arguments)}var a=function(t,n,e,r){try{var o=r.appControl.editControl.handlers;return null==o[t]?Promise.resolve([n,{status:0,msg:null}]):Promise.resolve(o[t](n,e,r,t)).then(function(t){return[t[0],t[1]]})}catch(t){return Promise.reject(t)}},s=function(n,e){try{var r=e.store,o=e.session,a=e.appControl.dataControl,s=a.table,i=a.byvars,l=e.state.columns;if(null===i||0===i.length)return Promise.resolve();var u={};for(var c in n)"_index_"!==c&&!1===l[c].custom&&(u[c]=n[c]);var f={};return i.forEach(function(t){f[t]=u[t]}),Promise.resolve(t(r,o,{table:s,data:u,where:f}))}catch(t){return Promise.reject(t)}},i=function(t,n,e,r,i){try{var l=function(){return Promise.resolve(a("main",u,e,i)).then(function(t){function n(){return u=t[0],m.msg=m.msg+" / "+t[1],!0===i.appControl.dataControl.cachePolicy&&(i.state.data[e]=u),{data:u,status:m}}var r=function(){if(!0===v)return Promise.resolve(a("term",t[0],e,i)).then(function(n){return t=n,Promise.resolve(s(u,i)).then(function(){})})}();return r&&r.then?r.then(n):n()})},u=o({},null!==r?r:i.state.data[e]),c=i.appControl.editControl,f=c.handlers,v=c.autoSave;u[t]=function(t,n){var e=t;return"string"!=typeof e||"decimal"!==n.Type&&"number"!==n.Type&&"double"!==n.Type||(e=parseFloat(1*t),!0===isNaN(t)&&(t=0)),e}(n,i.state.columns[t]);var m={status:0,msg:""},h=function(){if(null!=f[t])return Promise.resolve(f[t](u,t,e,i)).then(function(t){u=t[0],m=t[1]})}();return Promise.resolve(h&&h.then?h.then(l):l())}catch(t){return Promise.reject(t)}};function l(t,n,e){if(!t.s){if(e instanceof u){if(!e.s)return void(e.o=l.bind(null,t,n));1&n&&(n=e.s),e=e.v}if(e&&e.then)return void e.then(l.bind(null,t,n),l.bind(null,t,2));t.s=n,t.v=e;var r=t.o;r&&r(t)}}const u=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(n,e){const r=new t,o=this.s;if(o){const t=1&o?n:e;if(t){try{l(r,1,t(this.v))}catch(t){l(r,2,t)}return r}return this}return this.o=function(t){try{const o=t.v;1&t.s?l(r,1,n?n(o):o):e?l(r,1,e(o)):l(r,2,o)}catch(t){l(r,2,t)}},r},t}();var c=function(t,e){try{var r=e.store,s=e.session,i=o({},t);return null==i.table&&(i.table=e.appControl.dataControl.table),null==i.where&&(i.where={}),i.from<=0||-1===i.next?Promise.resolve(null):Promise.resolve(n(r,s,i)).then(function(t){return Promise.resolve(function(t,n){try{var e=function(){var t={};if(r.forEach(function(n,e){var r=n.Column.toLowerCase();n.name=r,n.Label=null==n.Label||0===n.Label.length?n.Column:n.Label,n.custom=!1,t[r]=n}),null!=i)for(var n in i){var e=o({},i[n]);e.name=n,e.custom=!0,t[n]=e}return{columns:t,data:c}},r=t.schema,s=t.rows,i=n.appControl.dataControl.customColumns,c=[],f=(v=s,m=function(t){var e=function(t,n){var e={};if(n.forEach(function(n,r){var o=t[r],a=o.Column.toLowerCase();null==o.Label&&(o.Label=o.Column),e[a]=n}),null!=i)for(var r in i){var o=i[r],a=o.Column.toLowerCase();e[a]=o.value}return e}(r,s[t]);return Promise.resolve(a("init",e,t,n)).then(function(t){var n=t[0],e=t[1];0!==e.code&&console.log(JSON.stringify(e,null,4)),c.push(n)})},d=-1,function t(n){try{for(;++d<v.length;)if((n=m(d))&&n.then){if(!((e=n)instanceof u&&1&e.s))return void n.then(t,p||(p=l.bind(null,h=new u,2)));n=n.v}h?l(h,1,n):h=n}catch(t){l(h||(h=new u),2,t)}var e}(),h);return Promise.resolve(f&&f.then?f.then(e):e())}catch(t){return Promise.reject(t)}var v,m,h,p,d}(t.data,e)).then(function(n){return e.state={modified:[],pagination:o({},t.pagination),currentPage:i,data:[],columns:[]},!0===e.appControl.dataControl.cachePolicy&&(e.state.data=n.data,e.state.columns=n.columns),n.pagination=o({},t.pagination),n})})}catch(t){return Promise.reject(t)}},f=function(t,n){try{var e,r=n.appControl.dataControl,a=r.table;if("first"===t)(e=o({},r.initialFetch)).table=a;else if(-1===(e=n.state.pagination[t]).next)return Promise.resolve(null);return console.log(e),Promise.resolve(c(e,n))}catch(t){return Promise.reject(t)}},v=function(t,n){try{var o=r();return null==t.authType&&(t.authType="code"),Promise.resolve(e(o,t)).then(function(e){var r={store:o,session:e.session,servers:e.servers,restaflib:null,logonPayload:t,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}}};return r.appControl=n,r.id=Date(),r})}catch(t){return Promise.reject(t)}};export{i as cellEdit,a as commonHandler,c as fetchTableRows,f as scrollTable,v as setup,s as updateTableRows};
//# sourceMappingURL=index.module.js.map
