import{casUpdateData as e,computeFetchData as t,casFetchRows as r,computeSetup as n,computeSetupTables as o,casSetup as s,caslRun as a,casUpload as i}from"@sassoftware/restaflib";import{initStore as u}from"@sassoftware/restaf";import l from"deepmerge";function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},c.apply(this,arguments)}var f=function(e,t,r,n){try{var o=n.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,r,n,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}},m=function(t,r){try{var n,o="cas"===r.source?Promise.resolve(function(t,r){try{var n=r.store,o=r.session,s=r.appControl,a=s.table,i=s.byvars,u=r.state.columns;if(null===i||0===i.length)return Promise.resolve(null);var l={};for(var c in t)"_index_"!==c&&"_rowIndex"!==c&&!1===u[c].custom&&(l[c]=t[c]);var f={};return i.forEach(function(e){f[e]=l[e]}),Promise.resolve(e(n,o,{table:a,data:l,where:f})).then(function(e){var t={statusCode:0,msg:"Save successful"};return"Normal"!==e.items().toJS().disposition.severity&&(t.statusCode=2,t.msg=l.disposition.severity.reason),t})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e}):Promise.resolve(function(e,t){try{var r=t.store,n=t.session,o=t.appControl,s=o.table,a=o.byvars,i=t.state.columns;if(null===a||0===a.length)return Promise.resolve(null);var u="proc sql; update "+s.libref+"."+s.name,l="SET ",c=" ";for(var f in e)!1===i[f].custom&&(l=l+c+f+"="+v(e[f])),c=", ";u=u+" "+l;var m=" WHERE ",h=" ";a.forEach(function(t){m=m+h+t+"="+v(e[t]),h="AND "});var d={data:{code:(u=u+" "+m+";run;").split(/\r?\n/)}};return Promise.resolve(r.apiCall(n.links("execute"),d)).then(function(e){return Promise.resolve(r.jobState(e,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}}(t,r)).then(function(e){n=e});return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(e){return Promise.reject(e)}};function v(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}var h=function(e,t,r,n,o){try{var s,a=function(e){return s?e:Promise.resolve(f("main",i,r,o)).then(function(e){var t;function s(r){return t?r:(i=e[0],!0===o.appControl.cachePolicy&&(o.state.data[n._rowIndex]=i),{data:i,status:h})}var a=function(){if(!0===v)return Promise.resolve(f("term",e[0],r,o)).then(function(r){return 2===(h=(e=r)[1]).statusCode?(t=1,{data:e[0],status:h}):Promise.resolve(m(e[0],o)).then(function(e){h=e})})}();return a&&a.then?a.then(s):s(a)})},i=c({},n),u=o.appControl.editControl,l=u.handlers,v=u.autoSave;i[e]=function(e,t){var r=e,n=t.Type.toLowerCase();return"string"!=typeof r||"decimal"!==n&&"number"!==n&&"double"!==n&&"float"!==n||(r=parseFloat(1*e),!0===isNaN(e)&&(e=0)),r}(t,o.state.columns[e]);var h={statusCode:0,msg:""},d=function(){if(null!=l[e])return Promise.resolve(l[e](i,e,r,o)).then(function(e){if(i=e[0],2===(h=e[1]).statusCode)return s=1,{data:e[0],status:h}})}();return Promise.resolve(d&&d.then?d.then(a):a(d))}catch(e){return Promise.reject(e)}};function d(e,t,r){if(!e.s){if(r instanceof p){if(!r.s)return void(r.o=d.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(d.bind(null,e,t),d.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var P=function(e,t){try{var r=function(){var e={};if(n.forEach(function(t,r){var n=t.Column.toLowerCase();t.name=n,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,e[n]=t}),null!=s)for(var t in s){var r=c({},s[t]);r.name=t,r.custom=!0,e[t]=r}return{columns:e,data:i,status:a}},n=e.schema,o=e.rows,s=t.appControl.customColumns,a={statusCode:0,msg:"Initialization was successful"},i=[],u=(l=o,m=function(e){var r=function(e,t,r){var n={_rowIndex:r};if(t.forEach(function(t,r){var o=e[r].Column.toLowerCase();n[o]=t}),null!=s)for(var o in s){var a=s[o],i=a.Column.toLowerCase();n[i]=a.value}return n}(n,o[e],e);return Promise.resolve(f("init",r,e,t)).then(function(e){a=e[1],i.push(e[0])})},P=-1,function e(t){try{for(;++P<l.length;)if((t=m(P))&&t.then){if(!((r=t)instanceof p&&1&r.s))return void t.then(e,h||(h=d.bind(null,v=new p,2)));t=t.v}v?d(v,1,t):v=t}catch(e){d(v||(v=new p),2,e)}var r}(),v);return Promise.resolve(u&&u.then?u.then(r):r())}catch(e){return Promise.reject(e)}var l,m,v,h,P};const p=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{d(n,1,e(this.v))}catch(e){d(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?d(n,1,t?t(o):o):r?d(n,1,r(o)):d(n,2,o)}catch(e){d(n,2,e)}},n},e}();var g=function(e,n){try{var o=null,s="cas"===n.source?Promise.resolve(function(e,t){try{var n=t.store,o=t.session,s=c({},e);return s.from<=0||-1===s.next?Promise.resolve(null):(null==s.where&&(s.where=" "),Promise.resolve(r(n,o,s)).then(function(e){var r=null,n=function(){if(null!==e)return Promise.resolve(P(e.data,t)).then(function(n){r=n,t.state={modified:[],pagination:c({},e.pagination),currentPage:s,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=r.data,t.state.columns=r.columns),r.pagination=c({},e.pagination)})}();return n&&n.then?n.then(function(){return r}):r}))}catch(e){return Promise.reject(e)}}(e,n)).then(function(e){o=e}):Promise.resolve(function(e,r){try{var n=r.store,o=r.tableSummary,s=r.appControl.table,a=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(t(n,o,a,null,{qs:{start:e.from-1,limit:e.count,format:null==e.format&&e.format}})).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(P(e,r)).then(function(e){r.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,n)).then(function(e){o=e});return Promise.resolve(s&&s.then?s.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},y=function(e,n,o){try{var s,a="cas"===n.source?Promise.resolve(function(e,t,n){try{var o,s=t.store,a=t.session,i=t.appControl,u=i.table;if("first"===e)o=c({},i.initialFetch);else if(null!==e&&(-1===(o=c({},t.state.pagination[e])).next||o.from<=0))return Promise.resolve(null);return null!=n&&(o=c({},n)),o.table=u,Promise.resolve(r(s,a,o)).then(function(e){var r=null;return function(){if(null!==e)return Promise.resolve(P(e.data,t)).then(function(n){return r=n,t.state={modified:[],pagination:c({},e.pagination),currentPage:o,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=r.data,t.state.columns=r.columns),r.pagination=c({},e.pagination),r})}()})}catch(e){return Promise.reject(e)}}(e,n,o)).then(function(e){s=e}):Promise.resolve(function(e,r,n){try{var o=r.store,s=r.tableSummary,a=r.appControl,i=a.table,u=a.initialFetch,l=null,f=(i.libref+"."+i.name).toLowerCase();return null==n?"first"===e&&(l=c({},u)):l=c({},n),Promise.resolve(t(o,s,f,e,l)).then(function(e){var t=null,n=function(){if(null!==e)return Promise.resolve(P(e,r)).then(function(e){r.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,n,o)).then(function(e){s=e});return Promise.resolve(a&&a.then?a.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},b=function(e,t,r){try{var a,i=u();null==e.authType&&(e.authType="code");var c="cas"===t.source?Promise.resolve(function(e,t,r){try{return Promise.resolve(s(e,t)).then(function(n){return{source:r.source,store:e,session:n.session,servers:n.servers,restaflib:null,logonPayload:t,appControl:r,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})}catch(e){return Promise.reject(e)}}(i,e,t)).then(function(e){a=e}):Promise.resolve(function(e,t,r,s){try{return Promise.resolve(n(e,r.computeContext,t)).then(function(n){return Promise.resolve(o(e,n,r.table,s)).then(function(o){return{source:r.source,store:e,session:n,tableSummary:o,servers:null,restaflib:null,logonPayload:t,appControl:l(r),state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(e){return Promise.reject(e)}}(i,e,t,r)).then(function(e){a=e});return Promise.resolve(c&&c.then?c.then(function(){return a}):a)}catch(e){return Promise.reject(e)}},C=function(e,t,r,n){try{var o,s="cas"===r.source?Promise.resolve(function(e,t,r,n){try{return Promise.resolve(a(r.store,r.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:e,column:t},!0)).then(function(e){if(0!==e.results.casResults.data.statusCode)throw"Failed to create unique list";return e.results.casResults.data.data})}catch(e){return Promise.reject(e)}}(e,t,r)).then(function(e){o=e}):Promise.resolve(function(e,t,r){try{var n={};return n[e]=[],Promise.resolve(n)}catch(e){return Promise.reject(e)}}(e)).then(function(e){o=e});return Promise.resolve(s&&s.then?s.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},j=function(e,t,r,n){try{return console.log("calling casUpload"),Promise.resolve(i(e,t,null,"casuser.temp",!0,n)).then(function(e){console.log("end of casUpload"),console.log(e.items().toJS())})}catch(e){return Promise.reject(e)}},w=function(e,t,r,n,o){try{for(var s=function(){return console.log(m.items().toJS()),m},a=o.store,u=o.session,l=t[0],f=0;f<r.length;f++)delete l[r[f]];l=c({},n,l);for(var m,v=Object.keys(l),h=v.join(",")+"\n",d=function(e){var r=t[e];r=c({},r,n);var o=[];v.forEach(function(e,t){var n=r[e];"string"==typeof n&&(n=n.trim()),o[t]=n}),h=h+o.join(",")+"\n"},P=0;P<t.length;P++)d(P);console.log(h),console.log(i),console.log(j);var p=function(){if("cas"===o.source)return Promise.resolve(j(a,u,0,h)).then(function(e){m=e});m={}}();return Promise.resolve(p&&p.then?p.then(s):s())}catch(e){return Promise.reject(e)}},S=function(e,t,r){return Promise.resolve([])};export{h as cellEdit,f as commonHandler,C as distinctValues,g as fetchTableRows,y as scrollTable,b as setup,S as sort,m as updateTableRows,w as uploadData};
//# sourceMappingURL=index.module.js.map
