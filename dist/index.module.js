import{casUpdateData as e,computeFetchData as t,casFetchRows as n,computeSetup as r,computeSetupTables as o,casSetup as s,caslRun as i,casUpload as a,casAppendTable as u,computeRun as c,casSaveTable as l}from"@sassoftware/restaflib";import{initStore as f}from"@sassoftware/restaf";function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m.apply(this,arguments)}var v=function(e,t,n,r){try{var o=r.appControl.editControl.handlers;return null==o[e]?Promise.resolve([t,{statusCode:0,msg:null}]):Promise.resolve(o[e](t,n,r,e)).then(function(e){return[e[0],e[1]]})}catch(e){return Promise.reject(e)}};function h(e,t,n){if(!e.s){if(n instanceof P){if(!n.s)return void(n.o=h.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(h.bind(null,e,t),h.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var d=function(e,t,n){try{var r=n.data,o=n.table,s=n.where,i="proc sql; update "+o.libref+"."+o.name,a="SET ",u=" ";for(var c in r)a=a+u+c+"="+b(r[c]),u=", ";i=i+" "+a;var l=" WHERE ",f=" ";for(var m in s)l=l+f+m+"= "+b(s[m])+" ",f=" AND ";var v={data:{code:(i=i+" "+l+";run;").split(/\r?\n/)}};return Promise.resolve(e.apiCall(t.links("execute"),v)).then(function(t){return Promise.resolve(e.jobState(t,{qs:{newState:"Completed",timeout:1}})).then(function(e){return{statusCode:"completed"===e.data?0:1,msg:e.data}})})}catch(e){return Promise.reject(e)}};const P=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{h(r,1,e(this.v))}catch(e){h(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?h(r,1,t?t(o):o):n?h(r,1,n(o)):h(r,2,o)}catch(e){h(r,2,e)}},r},e}();var p=function(t,n){try{var r=n.store,o=n.session,s="cas"===n.source?e:d,i=function(e,t){var n=t.appControl,r=n.table,o=n.byvars,s=t.state.columns,i={};for(var a in e)"_index_"!==a&&"_rowIndex"!==a&&!1===s[a].custom&&(i[a]=e[a]);var u={};return o.forEach(function(e){u[e]=i[e]}),{table:r,data:i,where:u}}(t,n);return Promise.resolve(s(r,o,i))}catch(e){return Promise.reject(e)}},y=function(e,t){try{var n,r=t.appControl.byvars;if(null===r||0===r.length)return Promise.resolve([null,{msg:"Error: Please specify a by variable",statusCode:1}]);var o=function(){if(!0!==Array.isArray(e))return Promise.resolve(p(e,t)).then(function(e){n=e});var r,o,s,i,a,u=(r=e,o=function(r){return Promise.resolve(p(e[r],t)).then(function(e){n=e})},a=-1,function e(t){try{for(;++a<r.length;)if((t=o(a))&&t.then){if(!((n=t)instanceof P&&1&n.s))return void t.then(e,i||(i=h.bind(null,s=new P,2)));t=t.v}s?h(s,1,t):s=t}catch(e){h(s||(s=new P),2,e)}var n}(),s);return u&&u.then?u.then(function(){}):void 0}();return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(e){return Promise.reject(e)}};function b(e){return null==e?".":"string"==typeof e?JSON.stringify(e):e.toString()}var g=function(e,t,n,r,o){try{var s,i=function(e){return s?e:Promise.resolve(v("main",a,n,o)).then(function(e){var t;function s(n){return t?n:(a=e[0],!0===o.appControl.cachePolicy&&(o.state.data[r._rowIndex]=a),{data:a,status:f})}var i=function(){if(!0===l)return Promise.resolve(v("term",e[0],n,o)).then(function(n){return 2===(f=(e=n)[1]).statusCode?(t=1,{data:e[0],status:f}):Promise.resolve(y(e[0],o)).then(function(e){f=e})})}();return i&&i.then?i.then(s):s(i)})},a=m({},r),u=o.appControl.editControl,c=u.handlers,l=u.autoSave;a[e]=function(e,t){var n=e,r=t.Type.toLowerCase();return"string"!=typeof n||"decimal"!==r&&"number"!==r&&"double"!==r&&"float"!==r||(n=parseFloat(1*e),!0===isNaN(e)&&(e=0)),n}(t,o.state.columns[e]);var f={statusCode:0,msg:""},h=function(){if(null!=c[e])return Promise.resolve(c[e](a,e,n,o)).then(function(e){if(a=e[0],2===(f=e[1]).statusCode)return s=1,{data:e[0],status:f}})}();return Promise.resolve(h&&h.then?h.then(i):i(h))}catch(e){return Promise.reject(e)}};function C(e,t,n){if(!e.s){if(n instanceof w){if(!n.s)return void(n.o=C.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(C.bind(null,e,t),C.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var j=function(e,t){try{var n=function(){var e={};if(r.forEach(function(t,n){var r=t.Column.toLowerCase();t.name=r,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,e[r]=t}),null!=s)for(var t in s){var n=m({},s[t]);n.name=t,n.custom=!0,e[t]=n}return{columns:e,data:a,status:i}},r=e.schema,o=e.rows,s=t.appControl.customColumns,i={statusCode:0,msg:"Initialization was successful"},a=[],u=(c=o,l=function(e){var n=function(e,t,n){var r={_rowIndex:n};if(t.forEach(function(t,n){var o=e[n].Column.toLowerCase();r[o]=t}),null!=s)for(var o in s){var i=s[o],a=i.Column.toLowerCase();r[a]=i.value}return r}(r,o[e],e);return Promise.resolve(v("init",n,e,t)).then(function(e){i=e[1],a.push(e[0])})},d=-1,function e(t){try{for(;++d<c.length;)if((t=l(d))&&t.then){if(!((n=t)instanceof w&&1&n.s))return void t.then(e,h||(h=C.bind(null,f=new w,2)));t=t.v}f?C(f,1,t):f=t}catch(e){C(f||(f=new w),2,e)}var n}(),f);return Promise.resolve(u&&u.then?u.then(n):n())}catch(e){return Promise.reject(e)}var c,l,f,h,d};const w=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{C(r,1,e(this.v))}catch(e){C(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?C(r,1,t?t(o):o):n?C(r,1,n(o)):C(r,2,o)}catch(e){C(r,2,e)}},r},e}();var _=function(e,r){try{return Promise.resolve("cas"===r.source?function(e,t){try{var r=t.store,o=t.session,s={};return null!=e.qs?((s=m({},e.qs)).from=s.start+1,s.count=s.limit):s=m({},e),s.from<=0||-1===s.next?Promise.resolve(null):(null==s.where&&(s.where=" "),Promise.resolve(n(r,o,s)).then(function(e){var n=null,r=function(){if(null!==e)return Promise.resolve(j(e.data,t)).then(function(r){n=r,t.state={modified:[],pagination:m({},e.pagination),currentPage:s,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=n.data,t.state.columns=n.columns),n.pagination=m({},e.pagination)})}();return r&&r.then?r.then(function(){return n}):n}))}catch(e){return Promise.reject(e)}}(e,r):function(e,n){try{var r=n.store,o=n.tableSummary,s=n.appControl.table,i=(s.libref+"."+s.name).toLowerCase();return Promise.resolve(t(r,o,i,null,{qs:{start:e.from-1,limit:e.count,format:null==e.format&&e.format}})).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(j(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,r))}catch(e){return Promise.reject(e)}},x=function(e,r,o){try{var s,i="cas"===r.source?Promise.resolve(function(e,t,r){try{var o,s=t.store,i=t.session,a=t.appControl,u=a.initialFetch,c=a.table;if(null!=r)o=m({},r);else if("first"===e)o=m({},u);else if(null!==e&&(-1===(o=m({},t.state.pagination[e])).next||o.from<=0))return Promise.resolve(null);var l={};return null!=o.qs?((l=m({},o.qs)).from=l.start+1,l.count=l.limit):l=m({},o),l.from<=0||-1===l.next?Promise.resolve(null):(null==l.where&&(l.where=" "),l.table=c,Promise.resolve(n(s,i,l)).then(function(e){var n=null;return function(){if(null!==e)return Promise.resolve(j(e.data,t)).then(function(r){return n=r,t.state={modified:[],pagination:m({},e.pagination),currentPage:o,data:[],columns:[]},!0===t.appControl.cachePolicy&&(t.state.data=n.data,t.state.columns=n.columns),n.pagination=m({},e.pagination),n})}()}))}catch(e){return Promise.reject(e)}}(e,r,o)).then(function(e){s=e}):Promise.resolve(function(e,n,r){try{var o=n.store,s=n.tableSummary,i=n.appControl,a=i.table,u=i.initialFetch,c=null,l=(a.libref+"."+a.name).toLowerCase();return null==r?"first"===e&&(c=m({},u)):c=m({},r),Promise.resolve(t(o,s,l,e,c)).then(function(e){var t=null,r=function(){if(null!==e)return Promise.resolve(j(e,n)).then(function(e){n.state={modified:[],pagination:{},currentPage:{},data:(t=e).data,columns:t.columns}})}();return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,r,o)).then(function(e){s=e});return Promise.resolve(i&&i.then?i.then(function(){return s}):s)}catch(e){return Promise.reject(e)}},L=function(e,t,n){try{var a,u=f();null==e.authType&&(e.authType="code");var c="cas"===t.source?Promise.resolve(function(e,t,n,r){try{return Promise.resolve(s(e,t)).then(function(o){var s={source:n.source,store:e,session:o.session,servers:o.servers,restaflib:null,logonPayload:t,appControl:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()},a=function(){if(null!=r)return Promise.resolve(i(e,o.session,r)).then(function(e){if(0!==e.details.statusCode)throw console.log(e),"Preamble failed. Please see console"})}();return a&&a.then?a.then(function(e){return s}):s})}catch(e){return Promise.reject(e)}}(u,e,t,n)).then(function(e){a=e}):Promise.resolve(function(e,t,n,s){try{return Promise.resolve(r(e,n.computeContext,t)).then(function(r){return Promise.resolve(o(e,r,n.table,s)).then(function(o){return{source:n.source,store:e,session:r,tableSummary:o,servers:null,restaflib:null,logonPayload:t,appControl:n,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}})})}catch(e){return Promise.reject(e)}}(u,e,t,n)).then(function(e){a=e});return Promise.resolve(c&&c.then?c.then(function(){return a}):a)}catch(e){return Promise.reject(e)}},E=function(e,t,n,r){try{var o,s="cas"===n.source?Promise.resolve(function(e,t,n,r){try{return Promise.resolve(i(n.store,n.session,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",{table:e,column:t},!0)).then(function(e){if(0!==e.results.casResults.data.statusCode)throw"Failed to create unique list";return e.results.casResults.data.data})}catch(e){return Promise.reject(e)}}(e,t,n)).then(function(e){o=e}):Promise.resolve(function(e,t,n){try{var r={};return r[e]=[],Promise.resolve(r)}catch(e){return Promise.reject(e)}}(e)).then(function(e){o=e});return Promise.resolve(s&&s.then?s.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},S=function(e,t,n,r,o,s,i){try{var l=o.store,f=o.session,v=Object.keys(t[0]),h=["_index_","_rowIndex"];null!==n&&(h=h.concat(n));var d=v.filter(function(e){return!(h.indexOf(e)>=0)}),P={};d.forEach(function(e){P[e]=o.state.columns[e]});var p=null;"cas"===o.source&&(p=d.join(",")+"\n");for(var y,b=function(e){var n=t[e];n=m({},n,r);var o=[];d.forEach(function(e,t){var r=n[e];"string"==typeof r&&(r=r.trim()),o[t]=r}),p=null===p?o.join(",")+"\n":p+o.join(",")+"\n"},g=0;g<t.length;g++)b(g);var C="cas"===o.source?Promise.resolve(function(e,t,n,r,o,s){try{return Promise.resolve(a(e,t,null,n.caslib+"."+n.name,!0,r)).then(function(r){return null!=o?Promise.resolve(u(e,t,n,o,s)).then(function(e){return r=e}):r})}catch(e){return Promise.reject(e)}}(l,f,e,p,s,i)).then(function(e){y=e}):Promise.resolve(function(e,t,n,r,o){try{var s="data "+r.libref+"."+r.name+"; INFILE datalines delimiter=',' ;\n",i="",a="INPUT ";for(var u in n){var l=n[u];a=a+l.Column+" ","CHAR"===l.Type&&(i=i+"  "+l.Column+" $ "+l.length+" \n")}return i.length>0&&(i="LENGTH "+i+";\n"),s=s+";\n"+i+(a+=";\n")+"datalines;\n"+o+"\n; run; proc print;run;\n",Promise.resolve(c(e,t,s)).then(function(){return{msg:"done",statusCode:0}})}catch(e){return Promise.reject(e)}}(l,f,P,e,p)).then(function(e){y=e});return Promise.resolve(C&&C.then?C.then(function(){return y}):y)}catch(e){return Promise.reject(e)}},T=function(e,t){try{var n=e.store,r=e.session;return"compute"===e.source?Promise.resolve({msg:"Action does not apply to SAS 9 tables",statusCode:0}):Promise.resolve(l(n,r,null!=t?t:e.appControl.table)).then(function(){return{msg:"Table saved",statusCode:0}})}catch(e){return Promise.reject(e)}};export{g as cellEdit,v as commonHandler,E as distinctValues,_ as fetchTableRows,T as saveTable,x as scrollTable,L as setup,y as updateTableRows,S as uploadData};
//# sourceMappingURL=index.module.js.map
