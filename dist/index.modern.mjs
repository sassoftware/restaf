import{casUpdateData as t,computeUpdateData as n,casFetchRows as a,computeFetchData as e,casSetup as s,caslRun as o,computeSetup as l,computeSetupTables as r,computeRun as i,casUpload as u,casAppendTable as c,casSaveTable as f}from"@sassoftware/restaflib";import{initStore as m}from"@sassoftware/restaf";import d from"deepcopy";function p(){return p=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var a=arguments[n];for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&(t[e]=a[e])}return t},p.apply(this,arguments)}async function w(t,n,a,e){const{handlers:s}=e.appControl.editControl;if(null==s[t])return[n,{statusCode:0,msg:null}];{const[o,l]=await s[t](n,a,e,t);return[o,l]}}async function y(t,n){let a;const e=n.appControl.byvars;if(null===e||0===e.length)return[null,{msg:"Error: Please specify a by variable",statusCode:1}];if(!0===Array.isArray(t))for(let e=0;e<t.length;e++)a=await g(t[e],n);else a=await g(t,n);return a}async function g(a,e){const{store:s,session:o}=e,l="cas"===e.source?t:n,r=function(t,n){const{table:a,byvars:e}=n.appControl,s=n.state.columns,o={};for(const n in t)"_index_"!==n&&"_rowIndex"!==n&&!1===s[n].custom&&(o[n]=t[n]);const l={};return e.forEach(t=>{l[t]=o[t]}),{table:a,data:o,where:l}}(a,e);return await l(s,o,r)}async function C(t,n,a,e,s){let o=p({},e);const l=s.state.columns,{handlers:r,autoSave:i}=s.appControl.editControl;o[t]=function(t,n){let a=t;const e=n.Type.toLowerCase();return"string"!=typeof a||"decimal"!==e&&"number"!==e&&"double"!==e&&"float"!==e||(a=parseFloat(1*t),!0===isNaN(t)&&(t=0)),a}(n,l[t]);let u={statusCode:0,msg:""};if(null!=r[t]){const n=await r[t](o,t,a,s);if(o=n[0],u=n[1],2===u.statusCode)return{data:n[0],status:u}}let c=await w("main",o,a,s);if(!0===i){if(c=await w("term",c[0],a,s),u=c[1],2===u.statusCode)return{data:c[0],status:u};u=await y(c[0],s)}return o=c[0],!0===s.appControl.cachePolicy&&(s.state.data[e._rowIndex]=o),{data:o,status:u}}async function b(t,n){const{schema:a,rows:e}=t,s=n.appControl.customColumns;let o={statusCode:0,msg:"Initialization was successful"};const l=(t,n,a)=>{const e={_rowIndex:a};if(n.forEach((n,a)=>{const s=t[a].Column.toLowerCase();e[s]=n}),null!=s)for(const t in s){const n=s[t],a=n.Column.toLowerCase();e[a]=n.value}return e},r=[];for(let t=0;t<e.length;t++){const s=l(a,e[t],t),[i,u]=await w("init",s,t,n);o=u,r.push(i)}const i={};if(a.forEach((t,n)=>{const a=t.Column.toLowerCase();t.name=a,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,i[a]=t}),null!=s)for(const t in s){const n=p({},s[t]);n.name=t,n.custom=!0,i[t]=n}return{columns:i,data:r,status:o}}async function h(t,n){let s=null;return s="cas"===n.source?await async function(t,n){const{store:e,session:s}=n,o=p({},t);if(o.from<=0||-1===o.next)return null;null==o.where&&(o.where=" ");const l=await a(e,s,o);let r=null;return null!==l&&(r=await b(l.data,n),n.state={modified:[],pagination:p({},l.pagination),currentPage:o,data:[],columns:[]},!0===n.appControl.cachePolicy&&(n.state.data=r.data,n.state.columns=r.columns),r.pagination=p({},l.pagination)),r}(t,n):await async function(t,n){const{store:a,tableSummary:s}=n,{table:o}=n.appControl,l=`${o.libref}.${o.name}`.toLowerCase();let r={qs:{start:t.from-1,limit:t.count,format:null==t.format&&t.format}};const i=await e(a,s,l,null,r);let u=null;return null!==i&&(u=await b(i,n),n.state={modified:[],pagination:{},currentPage:{},data:u.data,columns:u.columns}),u}(t,n),s}async function _(t,n,s){let o;return o="cas"===n.source?await async function(t,n,e){const{store:s,session:o}=n,{initialFetch:l,table:r}=n.appControl;let i;if("first"===t)i=p({},l);else if(null!==t&&(i=p({},n.state.pagination[t]),-1===i.next||i.from<=0))return null;null!=e&&(i=p({},e)),i.table=r;const u=await a(s,o,i);let c=null;if(null!==u)return c=await b(u.data,n),n.state={modified:[],pagination:p({},u.pagination),currentPage:i,data:[],columns:[]},!0===n.appControl.cachePolicy&&(n.state.data=c.data,n.state.columns=c.columns),c.pagination=p({},u.pagination),c}(t,n,s):await async function(t,n,a){const{store:s,tableSummary:o}=n,{table:l,initialFetch:r}=n.appControl;let i=null;const u=`${l.libref}.${l.name}`.toLowerCase();null==a?"first"===t&&(i=p({},r)):i=p({},a);const c=await e(s,o,u,t,i);let f=null;return null!==c&&(f=await b(c,n),n.state={modified:[],pagination:{},currentPage:{},data:f.data,columns:f.columns}),f}(t,n,s),o}async function P(t,n,a){const e=m();let o;return null==t.authType&&(t.authType="code"),o="cas"===n.source?await async function(t,n,a,e){const o=await s(t,n);return{source:a.source,store:t,session:o.session,servers:o.servers,restaflib:null,logonPayload:n,appControl:d(a),state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}}(e,t,n):await async function(t,n,a,e){let s=await l(t,a.computeContext,n),o=await r(t,s,a.table,e);return{source:a.source,store:t,session:s,tableSummary:o,servers:null,restaflib:null,logonPayload:n,appControl:d(a),state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}}(e,t,n,a),o}async function L(t,n,a,e){let s;return s="cas"===a.source?await async function(t,n,a,e){const{store:s,session:l}=a,r={table:t,column:n},i=await o(s,l,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",r,!0);if(0!==i.results.casResults.data.statusCode)throw"Failed to create unique list";return i.results.casResults.data.data}(t,n,a):await async function(t,n,a){const e={};return e[t]=[],e}(t),s}async function v(t,n,a,e,s,o,l){const{store:r,session:f}=s;let m=Object.keys(n[0]),d=["_index_","_rowIndex"];null!==a&&(d=d.concat(a));const w=m.filter(t=>!(d.indexOf(t)>=0)),y={};w.forEach(t=>{y[t]=s.state.columns[t]});let g,C=null;"cas"===s.source&&(C=w.join(",")+"\n");for(let t=0;t<n.length;t++){let a=n[t];a=p({},a,e);const s=[];w.forEach((t,n)=>{let e=a[t];"string"==typeof e&&(e=e.trim()),s[n]=e}),C=null===C?s.join(",")+"\n":C+s.join(",")+"\n"}return g="cas"===s.source?await async function(t,n,a,e,s,o){const l=`${a.caslib}.${a.name}`;let r=await u(t,n,null,l,!0,e);return null!=s?(r=await c(t,n,a,s,o),r):r}(r,f,t,C,o,l):await async function(t,n,a,e,s){let o=`data ${e.libref}.${e.name}; INFILE datalines delimiter=',' ;\n`,l="",r="INPUT ";for(const t in a){const n=a[t];r=r+n.Column+" ","CHAR"===n.Type&&(l=l+" "+` ${n.Column} $ ${n.length} \n`)}return l.length>0&&(l="LENGTH "+l+";\n"),r+=";\n",o=o+";\n"+l+r+"datalines;\n"+s+"\n; run; proc print;run;\n",await i(t,n,o),{msg:"done",statusCode:0}}(r,f,y,t,C),g}async function x(t,n){const{store:a,session:e}=t;if("compute"===t.source)return{msg:"Action does not apply to SAS 9 tables",statusCode:0};const s=null!=n?n:t.appControl.table;return await f(a,e,s),{msg:"Table saved",statusCode:0}}export{C as cellEdit,w as commonHandler,L as distinctValues,h as fetchTableRows,x as saveTable,_ as scrollTable,P as setup,y as updateTableRows,v as uploadData};
//# sourceMappingURL=index.modern.mjs.map
