import{casUpdateData as t,casFetchRows as n,computeFetchData as a,casSetup as e,caslRun as o,computeSetup as s,computeSetupTables as l,computeRun as r,casUpload as i,casAppendTable as c,casSaveTable as u}from"@sassoftware/restaflib";import{initStore as f}from"@sassoftware/restaf";function p(){return p=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var a=arguments[n];for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&(t[e]=a[e])}return t},p.apply(this,arguments)}async function d(t,n,a,e){const{handlers:o}=e.appControl.editControl;if(null==o[t])return[n,{statusCode:0,msg:null}];{const[s,l]=await o[t](n,a,e,t);return[s,l]}}async function m(t,n){let a;const e=n.appControl.byvars;if(null===e||0===e.length)return[null,{msg:"Error: Please specify a by variable",statusCode:1}];if(!0===Array.isArray(t))for(let e=0;e<t.length;e++)a=await w(t[e],n);else a=await w(t,n);return a}async function w(n,a){const{store:e,session:o}=a,s="cas"===a.source?t:y,l=function(t,n){const{table:a,byvars:e}=n.appControl,o=n.state.columns,s={};for(const n in t)"_index_"!==n&&"_rowIndex"!==n&&!1===o[n].custom&&(s[n]=t[n]);const l={};return e.forEach(t=>{l[t]=s[t]}),{table:a,data:s,where:l}}(n,a);return await s(e,o,l)}async function y(t,n,a){const{data:e,table:o,where:s}=a;let l=`proc sql; update ${o.libref}.${o.name}`,r="SET ",i=" ";for(const t in e)r=r+i+t+"="+C(e[t]),i=", ";l=l+" "+r;let c=" WHERE ",u=" ";for(const t in s)c=c+u+t+`= ${C(s[t])} `,u=" AND ";l=l+" "+c+";run;";const f={data:{code:l.split(/\r?\n/)}},p=await t.apiCall(n.links("execute"),f),d=await t.jobState(p,{qs:{newState:"Completed",timeout:1}});return{statusCode:"completed"===d.data?0:1,msg:d.data}}function C(t){let n;return n=null==t?".":"string"==typeof t?JSON.stringify(t):t.toString(),n}async function b(t,n,a,e,o){let s=p({},e);const l=o.state.columns,{handlers:r,autoSave:i}=o.appControl.editControl,c=null==i||i,u=null==o.appControl.cachePolicy||o.appControl.cachePolicy;s[t]=function(t,n){let a=t;const e=n.Type.toLowerCase();return"string"!=typeof a||"decimal"!==e&&"number"!==e&&"double"!==e&&"float"!==e||(a=parseFloat(1*t),!0===isNaN(t)&&(t=0)),a}(n,l[t]);let f={statusCode:0,msg:""};if(null!=r[t]){const n=await r[t](s,t,a,o);if(s=n[0],f=n[1],2===f.statusCode)return{data:n[0],status:f}}let w=await d("main",s,a,o);if(!0===c){if(w=await d("term",w[0],a,o),f=w[1],2===f.statusCode)return{data:w[0],status:f};f=await m(w[0],o)}return s=w[0],!0===u&&(o.state.data[e._rowIndex]=s),{data:s,status:f}}async function g(t,n){const{schema:a,rows:e}=t,o=n.appControl.customColumns;let s={statusCode:0,msg:"Initialization was successful"};const l=(t,n,a)=>{const e={_rowIndex:a};if(n.forEach((n,a)=>{const o=t[a].Column.toLowerCase();e[o]=n}),null!=o)for(const t in o){const n=o[t],a=n.Column.toLowerCase();e[a]=n.value}return e},r=[];for(let t=0;t<e.length;t++){const o=l(a,e[t],t),[i,c]=await d("init",o,t,n);s=c,r.push(i)}const i={};if(a.forEach((t,n)=>{const a=t.Column.toLowerCase();t.name=a,t.Label=null==t.Label||0===t.Label.length?t.Column:t.Label,null==t.Type&&(t.Type=null==t.type?"double":t.type),t.custom=!1,i[a]=t}),null!=o)for(const t in o){const n=p({},o[t]);n.name=t,n.custom=!0,i[t]=n}return{columns:i,data:r,status:s}}async function h(t,e){const o="cas"===e.source?await async function(t,a){const{store:e,session:o}=a;let s={};if(null!=t.qs?(s=p({},t.qs),s.from=s.start+1,s.count=s.limit):s=p({},t),s.from<=0||-1===s.next)return null;null==s.where&&(s.where=" ");const l=await n(e,o,s);let r=null;return null!==l&&(r=await g(l.data,a),a.state={modified:[],pagination:p({},l.pagination),currentPage:s,data:[],columns:[]},!0===a.appControl.cachePolicy&&(a.state.data=r.data,a.state.columns=r.columns),r.pagination=p({},l.pagination)),r}(t,e):await async function(t,n){const{store:e,tableSummary:o}=n,{table:s}=n.appControl,l=`${s.libref}.${s.name}`.toLowerCase();let r={qs:{start:t.from-1,limit:t.count,format:null==t.format&&t.format}};const i=await a(e,o,l,null,r);let c=null;return null!==i&&(c=await g(i,n),n.state={modified:[],pagination:{},currentPage:{},data:c.data,columns:c.columns}),c}(t,e);return o}async function P(t,e,o){let s;return s="cas"===e.source?await async function(t,a,e){const{store:o,session:s}=a,{initialFetch:l,table:r}=a.appControl,i=null==a.appControl.cachePolicy||a.appControl.cachePolicy;let c;if(null!=e)c=p({},e);else if("first"===t)c=p({},l);else if(null!==t&&(c=p({},a.state.pagination[t]),-1===c.next||c.from<=0))return null;let u={};if(null!=c.qs?(u=p({},c.qs),u.from=u.start+1,u.count=u.limit):u=p({},c),u.from<=0||-1===u.next)return null;null==u.where&&(u.where=" "),u.table=r;const f=await n(o,s,u);let d=null;return null!==f?(d=await g(f.data,a),a.state={modified:[],pagination:p({},f.pagination),currentPage:c,data:[],columns:[]},!0===i&&(a.state.data=d.data,a.state.columns=d.columns),d.pagination=p({},f.pagination),d):void 0}(t,e,o):await async function(t,n,e){const{store:o,tableSummary:s}=n,{table:l,initialFetch:r}=n.appControl,i=null==n.appControl.cachePolicy||n.appControl.cachePolicy;let c=null;const u=`${l.libref}.${l.name}`.toLowerCase();null==e?"first"===t&&(c=p({},r)):c=p({},e);const f=await a(o,s,u,t,c);let d=null;return null!==f&&(d=await g(f,n),n.state={modified:[],pagination:{},currentPage:{},data:[],columns:[]},!0===i&&(n.state.data=d.data,n.state.columns=d.columns)),d}(t,e,o),s}async function E(t,n){const a=f();let r;return null==t.authType&&(t.authType="code"),r="cas"===n.source?await async function(t,n,a){const s=await e(t,n);let l={source:a.source,store:t,session:s.session,servers:s.servers,restaflib:null,logonPayload:n,appControl:a,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()};if(null!=a.preamble){const n=await o(t,s.session,a.preamble);if(0!==n.disposition.statusCode)throw console.log(JSON.stringify(n,null,4)),"Preamble failed. Please see console"}return l}(a,t,n):await async function(t,n,a){let e=await s(t,a.computeContext,n),o=await l(t,e,a.table,a.preamble);return{source:a.source,store:t,session:e,tableSummary:o,servers:null,restaflib:null,logonPayload:n,appControl:a,state:{modified:[],pagination:{},currentPage:{},data:{},columns:{}},id:Date()}}(a,t,n),r}async function $(t,n,e){let s;const l=null!=e?e:n.appControl.table;return s="cas"===n.source?await async function(t,n,a){const{store:e,session:s}=a,l={table:t,column:n},r=await o(e,s,"\n  results = selectionLists(_args_.column,_args_.table.caslib, _args_.table.name);\n  send_response({casResults = {data=results}});\n  ",l,!0);if(0!==r.results.casResults.data.statusCode)throw"Failed to create unique list";return r.results.casResults.data.data}(l,t,n):await async function(t,n,e){const{store:o,session:s}=e,l=`\n    PROC SQL;\n    CREATE TABLE WORK.QUERY\n    AS\n    SELECT distinct(${n}) as utype FROM ${t.libref}.${t.name};\n   QUIT;`,i=await r(o,s,l),c={};let u="first";const f=[];let p;do{p=await a(o,i,"QUERY",u);const t=p.rows.map(t=>t[0]);f.push(...t),u="next"}while(p.scrollOptions.indexOf("next")>=0);return c[n]=f,c}(l,t,n),s}async function x(t,n,a,e,o,s,l){const{store:u,session:f}=o;null===n&&(n=o.state.data);const d=Object.keys(n[0]);let m=["_index_","_rowIndex"];null!==a&&(m=m.concat(a));const w=d.filter(t=>!(m.indexOf(t)>=0)),y={};w.forEach(t=>{y[t]=o.state.columns[t]});let C,b=null;"cas"===o.source&&(b=w.join(",")+"\n");for(let t=0;t<n.length;t++){let a=n[t];a=p({},a,e);const o=[];w.forEach((t,n)=>{let e=a[t];"string"==typeof e&&(e=e.trim()),o[n]=e}),b=null===b?o.join(",")+"\n":b+o.join(",")+"\n"}return C="cas"===o.source?await async function(t,n,a,e,o,s){const l=`${a.caslib}.${a.name}`;let r=await i(t,n,null,l,!0,e);return null!=o?(r=await c(t,n,a,o,s),r):r}(u,f,t,b,s,l):await async function(t,n,a,e,o){let s=`data ${e.libref}.${e.name}; INFILE datalines delimiter=',' ;\n`,l="",i="INPUT ";for(const t in a){const n=a[t];i=i+n.Column+" ","CHAR"===n.Type&&(l=l+" "+` ${n.Column} $ ${n.length} \n`)}return l.length>0&&(l="LENGTH "+l+";\n"),i+=";\n",s=s+";\n"+l+i+"datalines;\n"+o+"\n; run; proc print;run;\n",await r(t,n,s),{msg:"done",statusCode:0}}(u,f,y,t,b),C}async function L(t,n){const{store:a,session:e}=t;if("compute"===t.source)return{msg:"Action does not apply to SAS 9 tables",statusCode:0};const o=null!=n?n:t.appControl.table;return await u(a,e,o),{msg:"Table saved",statusCode:0}}export{b as cellEdit,d as commonHandler,$ as distinctValues,h as fetchTableRows,L as saveTable,P as scrollTable,E as setup,m as updateTableRows,x as uploadData};
//# sourceMappingURL=index.modern.mjs.map
